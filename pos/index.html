<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <title>SUNDORICA_POS</title>
    <link rel="icon" type="image/png" href="logo.png">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Hind+Siliguri:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --bg-light: #f3f4f6; --surface-light: #ffffff; --text-primary-light: #1f2937; --text-secondary-light: #6b7280; --border-light: #d1d5db; --surface-muted-light: #f9fafb;
            --bg-dark: #111827; --surface-dark: #1f2937; --text-primary-dark: #f9fafb; --text-secondary-dark: #9ca3af; --border-dark: #4b5563; --surface-muted-dark: #374151;
        }
        body { font-family: 'Inter', 'Hind Siliguri', sans-serif; background-color: var(--bg-light); color: var(--text-primary-light); transition: background-color 0.3s, color 0.3s; }
        .dark body { background-color: var(--bg-dark); color: var(--text-primary-dark); }
        .bg-white { background-color: var(--surface-light); }
        .dark .bg-white { background-color: var(--surface-dark); }
        .text-gray-800, .text-gray-900 { color: var(--text-primary-light); }
        .dark .text-gray-800, .dark .text-gray-900 { color: var(--text-primary-dark); }
        .text-gray-500, .text-gray-600, .text-gray-700 { color: var(--text-secondary-light); }
        .dark .text-gray-500, .dark .text-gray-600, .dark .text-gray-700 { color: var(--text-secondary-dark); }
        .bg-gray-100, .bg-gray-50 { background-color: var(--surface-muted-light); }
        .dark .bg-gray-100, .dark .bg-gray-50 { background-color: var(--surface-muted-dark); }
        .border, .border-gray-300 { border-color: var(--border-light); }
        .dark .border, .dark .border-gray-300 { border-color: var(--border-dark); }
        .divide-y > :not([hidden]) ~ :not([hidden]) { border-color: var(--border-light); }
        .dark .divide-y > :not([hidden]) ~ :not([hidden]) { border-color: var(--border-dark); }
        input, select, textarea { border: 1px solid var(--border-light); }
        .dark input, .dark select, .dark textarea { border: 1px solid var(--border-dark); background-color: var(--surface-muted-dark); }
        input[readonly], textarea[readonly] { background-color: #e5e7eb; }
        .dark input[readonly], .dark textarea[readonly] { background-color: #4b5563; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #f1f1f1; } .dark ::-webkit-scrollbar-track { background: #2d3748; } ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; } ::-webkit-scrollbar-thumb:hover { background: #555; }
        .sidebar-item { transition: all 0.2s; } .sidebar-item.active { background-color: #4f46e5; color: white; } .sidebar-item:hover { background-color: #6366f1; color: white; }
        .page { display: none; } .page.active { display: block; }
        input:not([type="checkbox"]), select { -webkit-appearance: none; -moz-appearance: none; appearance: none; }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 10001; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 12px 20px; border-radius: 8px; color: white; font-weight: 500; display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: translateX(120%); transition: transform 0.5s ease-in-out; }
        .toast.show { transform: translateX(0); } .toast.success { background-color: #22c55e; } .toast.error { background-color: #ef4444; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 10000; display: none; }
        .modal-content { background-color: var(--surface-light); padding: 2rem; border-radius: 0.5rem; width: 90%; max-width: 500px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .dark .modal-content { background-color: var(--surface-dark); }
        #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); z-index: 10002; display: flex; justify-content: center; align-items: center; }
        .dark #loader-overlay { background-color: rgba(17, 24, 39, 0.8); }
        .loader { border: 8px solid #f3f3f3; border-top: 8px solid #4f46e5; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        .dark .loader { border-color: #374151; border-top-color: #6366f1; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .btn-loader { border: 4px solid #f3f3f3; border-top: 4px solid #ffffff; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 0 auto; }
        #license-lock-overlay { z-index: 20000; background-color: #111827; }

        .customer-edit-input:not([readonly]) { background-color: #fef9c3; border: 1px solid #facc15; border-radius: 4px; }
        .dark .customer-edit-input:not([readonly]) { background-color: #4b5563; }
        .suggestion-item:hover { background-color: #eef; }
        .dark .suggestion-item:hover { background-color: #4b5563; }
        .dark .cancel-btn { background-color: #991b1b; color: #fef2f2; }
        .dark .cancel-btn:hover { background-color: #b91c1c; }
        .no-spinners::-webkit-inner-spin-button, .no-spinners::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .no-spinners { -moz-appearance: textfield; }
    </style>
</head>
<body class="text-gray-800">

    <div id="login-screen" class="fixed inset-0 bg-gray-200 flex items-center justify-center z-[10003]">
        <div class="w-full max-w-sm p-8 space-y-6 bg-white rounded-lg shadow-xl">
            <div><h2 class="text-3xl font-extrabold text-center text-gray-900">POS Login</h2></div>
            <form id="login-form" class="space-y-6">
                <div><label for="username" class="block text-sm font-medium text-gray-700">Username</label><input id="username" name="username" type="text" required class="block w-full px-3 py-2 mt-1 border rounded-md"></div>
                <div><label for="password" class="block text-sm font-medium text-gray-700">Password</label><input id="password" name="password" type="password" required class="block w-full px-3 py-2 mt-1 border rounded-md"></div>
                <div id="login-error" class="text-sm text-red-600 text-center h-4"></div>
                <div><button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Login</button></div>
            </form>
        </div>
    </div>

    <div id="license-lock-overlay" class="fixed inset-0 flex items-center justify-center hidden bg-gray-900/95 backdrop-blur-sm z-[20000] p-4 font-sans">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl flex flex-col md:flex-row overflow-hidden border border-gray-700/50">
        <div class="w-full md:w-5/12 bg-gray-50 dark:bg-gray-900 p-8 flex flex-col items-center justify-center text-center relative overflow-hidden border-r border-gray-200 dark:border-gray-700">
            <div class="absolute top-0 left-0 w-full h-full dark:bg-gradient-to-br from-gray-800 to-black z-0 opacity-50"></div>
            <div class="relative z-10 w-full flex flex-col items-center">
                <h3 class="text-gray-900 dark:text-white font-bold text-xl mb-6 tracking-wide uppercase">Scan with bKash</h3>
                <div class="bg-white p-4 rounded-xl shadow-2xl mb-4 transform transition hover:scale-105 duration-300"><canvas id="generated-qr-code"></canvas></div>
                <p class="text-gray-500 dark:text-gray-400 font-mono text-sm tracking-wider mb-2">Personal Number</p>
                <div class="text-gray-900 dark:text-white text-lg font-bold tracking-widest">01684461983</div>
            </div>
        </div>
        <div class="w-full md:w-7/12 p-8 md:p-10 bg-white flex flex-col justify-center relative">
            <div id="license-header" class="mb-8">
                <div class="flex items-center gap-2 text-red-600 mb-2"><span class="material-icons text-2xl">error_outline</span><span class="font-bold text-sm uppercase tracking-wider">Subscription Expired</span></div>
                <h2 class="text-3xl font-extrabold text-gray-900 dark:text-white">Renew License</h2>
                <p class="text-gray-500 mt-2 text-sm">আপনার POS সিস্টেম পুনরায় সক্রিয় করতে অনুগ্রহ করে ৫০০ টাকা পরিশোধ করুন। পেমেন্ট সম্পন্ন হওয়ার সাথে সাথে আপনার অ্যাক্সেস পুনরায় চালু করা হবে।</p>
            </div>
            <div id="payment-details" class="space-y-6">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Total Amount</label>
                    <div class="flex items-center bg-gray-50 border border-gray-200 rounded-lg p-3">
                        <span class="text-gray-500 font-bold mr-2">৳</span><input type="text" id="payment-amount-fixed" value="500" readonly class="bg-transparent w-full text-gray-900 dark:text-white font-bold text-lg outline-none cursor-default">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">নিচের ঘরে ট্রানজেকশন আইডি অথবা যেই মোবাইল নম্বর থেকে টাকা পাঠানো হয়েছে, সেই নম্বরের শেষ ৩টি সংখ্যা লিখুন।</label>
                    <input type="text" id="trx-input" class="w-full border border-gray-300 rounded-lg p-3 text-gray-900 dark:text-white font-mono text-lg focus:ring-2 focus:ring-indigo-500 outline-none transition shadow-sm">
                </div>
                <button id="submit-payment-btn" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-lg text-lg hover:bg-indigo-700">Confirm Payment</button>
            </div>
            <div id="payment-pending-msg" class="hidden absolute inset-0 bg-white z-20 flex flex-col items-center justify-center text-center p-8">
                <div class="loader ease-linear rounded-full border-4 border-t-4 border-indigo-200 h-16 w-16 mb-4" style="border-top-color: #4f46e5;"></div>
                <h3 class="text-2xl font-bold text-gray-800 dark:text-white">Verifying...</h3>
                <p id="wait-msg" class="text-red-600 font-bold mt-2 mb-6">Please do not close this window Wait for confirmation.</p>
                <div id="payment-success-msg" class="hidden animate-bounce-in">
                    <h4 class="text-xl font-bold text-green-700 mb-4">Payment Successful!</h4>
                    <button onclick="this.innerHTML='<div class=\'btn-loader\'></div>'; this.disabled=true; setTimeout(function(){ document.getElementById('license-lock-overlay').style.display='none'; document.getElementById('main-app').classList.remove('hidden'); startApp(); }, 800);" class="bg-indigo-600 text-white py-2 px-6 rounded-lg font-bold">Reload POS</button>
                </div>
            </div>
        </div>
    </div>
    </div>

    <div id="license-warning-modal" class="modal-overlay">
        <div class="modal-content text-center border-l-4 border-yellow-500">
            <h2 class="text-xl font-bold text-yellow-600 mb-2">⚠ Renewal Reminder</h2>
            <p id="warning-text" class="text-gray-700 mb-4 font-medium"></p>
            <button id="close-warning-btn" class="bg-gray-800 text-white py-2 px-6 rounded hover:bg-gray-700">OK</button>
        </div>
    </div>

    <div id="loader-overlay" style="display: none;"><div class="loader"></div></div>
    <div id="toast-container"></div>

    <div id="main-app" class="hidden flex h-screen">
        <div class="w-64 bg-gray-800 text-white flex flex-col fixed h-full">
            <div class="px-6 py-4 text-2xl font-bold border-b border-gray-700">SUNDORICA</div>
            <nav class="flex-1 px-4 py-4 space-y-2 overflow-y-auto">
                <a href="#dashboard" class="sidebar-item group flex items-center px-4 py-2 text-base rounded-md"><span class="material-icons mr-3">dashboard</span> Dashboard</a>
                <a href="#bill" class="sidebar-item group flex items-center px-4 py-2 text-base rounded-md"><span class="material-icons mr-3">receipt_long</span> Bill</a>
                <a href="#products" class="sidebar-item group flex items-center px-4 py-2 text-base rounded-md"><span class="material-icons mr-3">inventory_2</span> Products</a>
                <a href="#sales" class="sidebar-item group flex items-center px-4 py-2 text-base rounded-md"><span class="material-icons mr-3">assessment</span> Sales</a>
                <a href="#stock" class="sidebar-item group flex items-center px-4 py-2 text-base rounded-md"><span class="material-icons mr-3">inventory</span> Stock</a>
                <a href="#customers" class="sidebar-item group flex items-center px-4 py-2 text-base rounded-md"><span class="material-icons mr-3">people</span> Customer List</a>
                <a href="#return" class="sidebar-item group flex items-center px-4 py-2 text-base rounded-md"><span class="material-icons mr-3">assignment_return</span> Return</a>
                <a href="#barcode" class="sidebar-item group flex items-center px-4 py-2 text-base rounded-md"><span class="material-icons mr-3">qr_code_2</span> Barcode Print</a>
                <a href="#brands" class="sidebar-item group flex items-center px-4 py-2 text-base rounded-md"><span class="material-icons mr-3">loyalty</span> Brand</a>
            </nav>
            <div class="p-4 mt-auto border-t border-gray-700 flex justify-start">
                <a href="#settings" title="Settings" class="sidebar-item text-gray-400 hover:text-white flex items-center justify-center w-10 h-10 rounded-full hover:bg-gray-700 transition">
                    <span class="material-icons">settings</span>
                </a>
            </div>
        </div>
        <main class="flex-1 ml-64 p-6 overflow-y-auto">
            <div class="flex justify-end items-center mb-4"><label for="dark-mode-toggle" class="mr-2 text-sm font-medium">Dark Mode</label><button id="dark-mode-toggle" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors bg-gray-200 dark:bg-gray-600 focus:outline-none"><span class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform translate-x-1 dark:translate-x-6"></span></button></div>
            
            <div id="dashboard" class="page"><h1 class="text-3xl font-bold mb-6">Dashboard</h1><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="bg-white p-6 rounded-lg shadow-md"><h2 class="text-lg font-semibold text-gray-500">Today's Sales</h2><p id="today-sales" class="text-3xl font-bold mt-2">0.00</p></div><div class="bg-white p-6 rounded-lg shadow-md"><h2 class="text-lg font-semibold text-gray-500">This Month's Sales</h2><p id="month-sales" class="text-3xl font-bold mt-2">0.00</p></div><div class="bg-white p-6 rounded-lg shadow-md"><h2 class="text-lg font-semibold text-gray-500">Today's Bill Quantity</h2><p id="today-qty" class="text-3xl font-bold mt-2">0</p></div></div></div>
            
            <div id="bill" class="page"><h1 class="text-3xl font-bold mb-6">Create Bill</h1><div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md"><h2 class="text-xl font-bold mb-4">Billing Items</h2><div class="grid grid-cols-12 gap-3 items-end mb-4"><div class="col-span-4"><label for="bill-sku" class="block text-sm font-medium text-gray-700">Enter SKU</label><input type="text" id="bill-sku" class="mt-1 block w-full rounded-md shadow-sm p-2"></div><div class="col-span-3"><label for="bill-pname" class="block text-sm font-medium text-gray-700">Product Name</label><input type="text" id="bill-pname" class="mt-1 block w-full rounded-md p-2" readonly></div><div class="col-span-2"><label for="bill-avail-qty" class="block text-sm font-medium text-gray-700">Available Qty</label><input type="text" id="bill-avail-qty" class="mt-1 block w-full rounded-md p-2" readonly></div><div class="col-span-2"><label for="bill-sale-qty" class="block text-sm font-medium text-gray-700">Sale Quantity</label><input type="number" id="bill-sale-qty" class="mt-1 block w-full rounded-md shadow-sm p-2"></div><div class="col-span-1 flex flex-col justify-end pb-[2px]"><label class="flex items-center justify-center gap-1 mb-1 text-[11px] font-bold text-gray-600 dark:text-gray-300 cursor-pointer select-none" title="Auto add 1 item on Enter"><input type="checkbox" id="auto-add-checkbox" class="w-3.5 h-3.5 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500"> Auto</label><button id="add-bill-item-btn" class="w-full bg-indigo-600 text-white py-2 rounded-md font-bold hover:bg-indigo-700 shadow-sm text-sm transition">Enter</button></div></div><div class="mt-6 flow-root"><div class="-my-2 -mx-4 overflow-x-auto sm:-mx-6 lg:-mx-8"><div class="inline-block min-w-full py-2 align-middle sm:px-6 lg:px-8"><table id="sale-items-table" class="min-w-full divide-y"><thead class="bg-gray-50"><tr><th class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold">SKU</th><th class="px-3 py-3.5 text-left text-sm font-semibold">Product Name</th><th class="px-3 py-3.5 text-left text-sm font-semibold">Quantity</th><th class="px-3 py-3.5 text-left text-sm font-semibold">MRP</th><th class="px-3 py-3.5 text-left text-sm font-semibold">Item Discount</th><th class="px-3 py-3.5 text-left text-sm font-semibold">Total</th><th class="relative py-3.5 pl-3 pr-4 sm:pr-0"><span class="sr-only">Remove</span></th></tr></thead><tbody id="sale-list-body" class="divide-y"></tbody></table></div></div></div></div><div class="bg-white p-6 rounded-lg shadow-md"><div class="mb-6"><h3 class="text-lg font-bold mb-4">Bill To</h3><div><label for="cust-phone" class="block text-sm font-medium text-gray-700">Customer Phone</label><div class="mt-1"><div class="flex gap-2"><input type="text" id="cust-phone" class="block w-full rounded-md shadow-sm p-2 border border-gray-300 dark:border-gray-600 focus:ring-indigo-500 focus:border-indigo-500" placeholder="01XXXXXXXXX" autocomplete="off"><button id="check-cust-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 font-bold focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Check</button></div><div id="cust-history-status" class="mt-1 text-[11px] font-bold hidden"></div></div></div><div class="mt-4"><label for="cust-name" class="block text-sm font-medium text-gray-700">Customer Name</label><input type="text" id="cust-name" class="mt-1 block w-full rounded-md p-2" readonly></div><div class="mt-4"><label for="cust-address" class="block text-sm font-medium text-gray-700">Customer Address</label><textarea id="cust-address" rows="2" class="mt-1 block w-full rounded-md p-2" readonly></textarea></div></div><div class="border-t pt-4"><h3 class="text-lg font-bold mb-4">Billing Summary</h3><div class="space-y-3 text-sm"><div class="flex justify-between"><span>Subtotal</span><span id="summary-subtotal">0.00</span></div><div class="flex items-center justify-between"><span>Discount</span><div class="flex items-center gap-2"><input type="number" id="discount-value" placeholder="0" class="w-20 rounded-md text-right p-1 no-spinners focus:outline-none focus:border-indigo-500"><select id="discount-type" class="rounded-md p-1 bg-transparent cursor-pointer focus:outline-none focus:border-indigo-500" style="-webkit-appearance: none; -moz-appearance: none; appearance: none; text-align-last: center;"><option value="amount">৳</option><option value="percent">%</option></select></div></div><div class="flex justify-between"><span>Shipping Charges</span><input type="number" id="shipping-charges" placeholder="0.00" class="w-24 rounded-md text-right p-1 no-spinners focus:outline-none focus:border-indigo-500"></div><div class="flex justify-between font-medium"><span>Payment</span><input type="number" id="payment-amount" placeholder="0.00" class="w-24 rounded-md text-right p-1 no-spinners focus:outline-none focus:border-indigo-500"></div><div class="flex justify-between text-lg font-bold border-t pt-2 mt-2"><span>Due Amount</span><span id="summary-due-amount">0.00</span></div></div><button id="bill-now-btn" class="mt-6 w-full bg-indigo-600 text-white py-3 rounded-md font-bold hover:bg-indigo-700 transition">Bill Now</button></div></div></div></div>
            
            <div id="products" class="page"><h1 class="text-3xl font-bold mb-6">Manage Products</h1><div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold">Product List</h2><input type="text" id="product-search" placeholder="Search by SKU or Name..." class="block w-1/2 rounded-md shadow-sm p-2"></div><div class="overflow-auto h-96"><table class="min-w-full divide-y"><thead class="bg-gray-50 sticky top-0 z-10 shadow-sm"><tr><th class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold">SKU</th><th class="px-3 py-3.5 text-left text-sm font-semibold">Product Name</th><th class="px-3 py-3.5 text-left text-sm font-semibold">Brand</th><th class="px-3 py-3.5 text-left text-sm font-semibold">Purchase Price</th><th class="px-3 py-3.5 text-left text-sm font-semibold">MRP</th><th class="px-3 py-3.5 text-left text-sm font-semibold">Action</th></tr></thead><tbody id="product-list-body" class="divide-y"></tbody></table><div class="flex justify-center py-4"><button id="load-more-products" class="hidden bg-indigo-100 text-indigo-700 font-bold py-2 px-6 rounded-full hover:bg-indigo-200 transition-all dark:bg-indigo-900 dark:text-indigo-200">Load More Data</button></div></div></div><div class="bg-white p-6 rounded-lg shadow-md"><h2 class="text-xl font-bold mb-4">Add New Product</h2><form id="add-product-form" class="space-y-4"><div><label for="new-pname" class="block text-sm font-medium">Product Name</label><input type="text" id="new-pname" required class="mt-1 block w-full rounded-md p-2"></div><div><label for="new-pprice" class="block text-sm font-medium">Purchase Price</label><input type="number" id="new-pprice" required class="mt-1 block w-full rounded-md p-2"></div><div><label for="new-mrp" class="block text-sm font-medium">MRP</label><input type="number" id="new-mrp" required class="mt-1 block w-full rounded-md p-2"></div><div><label for="new-pqty" class="block text-sm font-medium">Purchase Quantity</label><input type="number" id="new-pqty" required class="mt-1 block w-full rounded-md p-2"></div><div class="relative"><label for="new-pbrand" class="block text-sm font-medium">Brand Name</label><input type="text" id="new-pbrand" autocomplete="off" required class="mt-1 block w-full rounded-md p-2"><div id="brand-suggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md mt-1 hidden max-h-40 overflow-y-auto"></div></div><button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded-md font-bold hover:bg-indigo-700">Save Product</button></form></div></div></div>
            
            <div id="sales" class="page"><h1 class="text-3xl font-bold mb-6">Sales Report</h1><div class="bg-white p-6 rounded-lg shadow-md"><div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 items-end"><div><label for="sales-from-date" class="block text-sm font-medium">From Date</label><input type="date" id="sales-from-date" class="mt-1 block w-full rounded-md p-2"></div><div><label for="sales-to-date" class="block text-sm font-medium">To Date</label><input type="date" id="sales-to-date" class="mt-1 block w-full rounded-md p-2"></div><div><input type="text" id="sales-search" placeholder="Search by Invoice or Phone..." class="block w-full rounded-md p-2"></div><div class="flex gap-2"><button id="show-report-btn" class="flex-1 bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700">Show Report</button><button id="download-sales-btn" class="flex-1 bg-green-600 text-white py-2 rounded-md hover:bg-green-700">Download CSV</button></div></div><div class="mt-4 flex items-center gap-2"><input type="text" id="reprint-invoice-id" placeholder="Enter Invoice NO to Reprint" class="block w-1/3 rounded-md p-2"><button id="reprint-btn" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700">Reprint</button></div><div class="w-full mt-4"><table id="sales-report-table" class="min-w-full divide-y"><thead class="bg-gray-50 sticky -top-6 z-20 shadow-md"><tr><th class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold">Invoice NO</th><th class="px-3 py-3.5 text-left text-sm font-semibold">Sale Date</th><th class="px-3 py-3.5 text-left text-sm font-semibold">Customer</th><th class="px-3 py-3.5 text-left text-sm font-semibold">Phone</th><th class="px-3 py-3.5 text-left text-sm font-semibold">Address</th><th class="px-3 py-3.5 text-left text-sm font-semibold">Due</th><th class="px-3 py-3.5 text-left text-sm font-semibold">Discount</th><th class="px-3 py-3.5 text-left text-sm font-semibold">Payment</th><th class="px-3 py-3.5 text-left text-sm font-semibold">Qty</th><th class="px-3 py-3.5 text-left text-sm font-semibold">Products</th></tr></thead><tbody id="sales-list-body" class="divide-y"></tbody></table><div class="flex justify-center py-4"><button id="load-more-sales" class="hidden bg-indigo-100 text-indigo-700 font-bold py-2 px-6 rounded-full hover:bg-indigo-200 transition-all dark:bg-indigo-900 dark:text-indigo-200">Load More Data</button></div></div></div></div>
            
            <div id="stock" class="page"><h1 class="text-3xl font-bold mb-6">Stock Report</h1><div class="bg-white p-6 rounded-lg shadow-md"><div class="flex justify-between items-center mb-4"><input type="text" id="stock-search" placeholder="Search by SKU or Name..." class="block w-1/2 rounded-md shadow-sm p-2"><div class="flex gap-2"><button id="add-stock-btn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">Add Stock</button><button id="download-stock-btn" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">Download CSV</button></div></div><div class="w-full"><table id="stock-report-table" class="min-w-full divide-y"><thead class="bg-gray-50 sticky -top-6 z-20 shadow-md"><tr><th class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold">SKU</th><th class="px-3 py-3.5 text-left text-sm font-semibold">Product Name</th><th class="px-3 py-3.5 text-left text-sm font-semibold">Brand</th><th class="px-3 py-3.5 text-left text-sm font-semibold">Purchase Price</th><th class="px-3 py-3.5 text-left text-sm font-semibold">MRP</th><th class="px-3 py-3.5 text-left text-sm font-semibold">Purchased Qty</th><th class="px-3 py-3.5 text-left text-sm font-semibold">Available Qty</th><th class="px-3 py-3.5 text-left text-sm font-semibold">Sold Qty</th></tr></thead><tbody id="stock-list-body" class="divide-y"></tbody></table><div class="flex justify-center py-4"><button id="load-more-stock" class="hidden bg-indigo-100 text-indigo-700 font-bold py-2 px-6 rounded-full hover:bg-indigo-200 transition-all dark:bg-indigo-900 dark:text-indigo-200">Load More Data</button></div></div></div></div>
            
            <div id="customers" class="page"><h1 class="text-3xl font-bold mb-6">Customer List</h1><div class="bg-white p-6 rounded-lg shadow-md"><div class="flex justify-between items-center mb-4"><input type="text" id="customer-search" placeholder="Search by Name or Phone..." class="block w-1/2 rounded-md shadow-sm p-2"></div><div class="w-full"><table id="customer-list-table" class="min-w-full divide-y"><thead class="bg-gray-50 sticky -top-6 z-20 shadow-md"><tr><th class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold">Customer Name</th><th class="px-3 py-3.5 text-left text-sm font-semibold">Customer Phone</th><th class="px-3 py-3.5 text-left text-sm font-semibold">Address</th><th class="px-3 py-3.5 text-left text-sm font-semibold">Actions</th></tr></thead><tbody id="customer-list-body" class="divide-y"></tbody></table><div class="flex justify-center py-4"><button id="load-more-customers" class="hidden bg-indigo-100 text-indigo-700 font-bold py-2 px-6 rounded-full hover:bg-indigo-200 transition-all dark:bg-indigo-900 dark:text-indigo-200">Load More Data</button></div></div></div></div>
            
            <div id="return" class="page"><h1 class="text-3xl font-bold mb-6">Process Return</h1><div class="bg-white p-6 rounded-lg shadow-md max-w-2xl mx-auto"><label for="return-invoice-id" class="block text-sm font-medium">Enter Invoice NO</label><div class="flex items-center gap-2 mt-1"><input type="text" id="return-invoice-id" class="block w-full rounded-md p-2"><button id="check-invoice-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Check</button></div><div id="return-products-container" class="mt-6 hidden"><h3 class="font-bold text-lg">Invoice Details <span id="return-invoice-display"></span></h3><div id="return-summary" class="text-sm text-gray-600 mb-4"></div><div id="return-product-list" class="mt-4 space-y-3"></div><div id="return-list-container" class="mt-6 hidden"><h3 class="font-bold text-lg">Items to Return</h3><ul id="return-queue-list" class="space-y-2 my-2"></ul><button id="process-return-list-btn" class="w-full bg-red-600 text-white py-2 rounded-md font-bold">Return All From List</button></div></div></div></div>
            
            <div id="barcode" class="page"><h1 class="text-3xl font-bold mb-6">Print Barcodes</h1><div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="bg-white p-6 rounded-lg shadow-md"><h2 class="text-xl font-bold mb-4">Add Products to Print Queue</h2><div class="flex items-end gap-4"><div class="flex-1"><label for="barcode-sku" class="block text-sm font-medium">Enter SKU</label><input type="text" id="barcode-sku" class="mt-1 block w-full rounded-md p-2"></div><div class="w-24"><label for="barcode-qty" class="block text-sm font-medium">Quantity</label><input type="number" id="barcode-qty" placeholder=" " class="mt-1 block w-full rounded-md p-2"></div><button id="add-to-print-btn" class="bg-blue-600 text-white py-2 px-4 rounded-md">Add to Print</button></div></div><div class="bg-white p-6 rounded-lg shadow-md"><h2 class="text-xl font-bold mb-4">Print Queue</h2><ul id="barcode-print-list" class="space-y-2 mb-4 h-48 overflow-y-auto"></ul><button id="generate-barcode-btn" class="w-full bg-indigo-600 text-white py-3 rounded-md font-bold">Generate Barcode PDF</button></div></div></div>
            
            <div id="brands" class="page"><h1 class="text-3xl font-bold mb-6">Manage Brands</h1><div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold">Brand List</h2><input type="text" id="brand-search" placeholder="Search brand..." class="block w-1/2 rounded-md shadow-sm p-2"></div><div class="overflow-auto h-96"><table class="min-w-full divide-y"><thead class="bg-gray-50 sticky top-0 z-10 shadow-sm"><tr><th class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold">Brand Name</th><th class="px-3 py-3.5 text-left text-sm font-semibold">Actions</th></tr></thead><tbody id="brand-list-body" class="divide-y"></tbody></table><div class="flex justify-center py-4"><button id="load-more-brands" class="hidden bg-indigo-100 text-indigo-700 font-bold py-2 px-6 rounded-full hover:bg-indigo-200 transition-all dark:bg-indigo-900 dark:text-indigo-200">Load More Data</button></div></div></div><div class="bg-white p-6 rounded-lg shadow-md"><h2 class="text-xl font-bold mb-4">Add New Brand</h2><form id="add-brand-form" class="space-y-4"><div><label for="new-brand-name" class="block text-sm font-medium">Brand Name</label><input type="text" id="new-brand-name" required class="mt-1 block w-full rounded-md p-2"></div><button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded-md font-bold hover:bg-indigo-700">Save Brand</button></form></div></div></div>

            <div id="settings" class="page">
                <h1 class="text-3xl font-bold mb-6">Settings</h1>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-md h-fit">
                        <h2 class="text-xl font-bold mb-4">Change Password</h2>
                        <form id="change-password-form" class="space-y-4">
                            <div><label class="block text-sm font-medium">Old Password</label><input type="password" id="old-password" required class="mt-1 block w-full rounded-md p-2 border border-gray-300"></div>
                            <div><label class="block text-sm font-medium">New Password</label><input type="password" id="new-password" required class="mt-1 block w-full rounded-md p-2 border border-gray-300"></div>
                            <div><label class="block text-sm font-medium">Confirm New Password</label><input type="password" id="confirm-password" required class="mt-1 block w-full rounded-md p-2 border border-gray-300"></div>
                            <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded-md font-bold hover:bg-indigo-700">Change Password</button>
                        </form>
                    </div>

                    <div id="admin-user-management" class="bg-white p-6 rounded-lg shadow-md h-fit hidden">
                        <h2 class="text-xl font-bold mb-4">User Management</h2>
                        <form id="add-user-form" class="space-y-4 mb-6 pb-6 border-b">
                            <div><label class="block text-sm font-medium">New Username</label><input type="text" id="new-username" required class="mt-1 block w-full rounded-md p-2 border border-gray-300"></div>
                            <div><label class="block text-sm font-medium">Password</label><input type="password" id="new-user-password" required class="mt-1 block w-full rounded-md p-2 border border-gray-300"></div>
                            <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-md font-bold hover:bg-green-700">Add User</button>
                        </form>
                        <h3 class="font-bold mb-2">Existing Users</h3>
                        <div class="overflow-auto max-h-48 border border-gray-200 rounded-md">
                            <table class="min-w-full divide-y">
                                <thead class="bg-gray-50"><tr><th class="px-3 py-2 text-left text-sm font-semibold">Username</th><th class="px-3 py-2 text-left text-sm font-semibold">Role</th><th class="px-3 py-2 text-left text-sm font-semibold">Action</th></tr></thead>
                                <tbody id="user-list-body" class="divide-y bg-white"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <div id="add-customer-modal" class="modal-overlay"><div class="modal-content"><h2 class="text-xl font-bold mb-4">Add New Customer</h2><form id="new-customer-form"><p class="mb-4">Customer with phone <strong id="new-cust-modal-phone"></strong> not found. Add them below.</p><div><label for="new-cust-modal-name" class="block text-sm font-medium">Customer Name</label><input type="text" id="new-cust-modal-name" required class="mt-1 block w-full rounded-md p-2"></div><div class="mt-4"><label for="new-cust-modal-address" class="block text-sm font-medium">Address</label><textarea id="new-cust-modal-address" rows="3" required class="mt-1 block w-full rounded-md p-2"></textarea></div><div class="mt-6 flex justify-end gap-3"><button type="button" id="cancel-add-customer" class="bg-gray-200 py-2 px-4 rounded-md cancel-btn">Cancel</button><button type="submit" class="bg-indigo-600 text-white py-2 px-4 rounded-md">Save Customer</button></div></form></div></div>
    <div id="return-qty-modal" class="modal-overlay"><div class="modal-content"><h2 class="text-xl font-bold mb-4">Return Quantity</h2><form id="return-qty-form"><p class="mb-4">Enter quantity to return for <strong id="return-modal-pname"></strong>.</p><input type="hidden" id="return-modal-sku"><input type="hidden" id="return-modal-invoiceid"><input type="hidden" id="return-modal-maxqty"><div><label for="return-modal-qty" class="block text-sm font-medium">Return Quantity</label><input type="number" id="return-modal-qty" required min="1" class="mt-1 block w-full rounded-md p-2"></div><div class="mt-6 flex justify-end gap-3"><button type="button" id="cancel-return-qty" class="bg-gray-200 py-2 px-4 rounded-md cancel-btn">Cancel</button><button type="submit" class="bg-green-600 text-white py-2 px-4 rounded-md">Add to Return List</button></div></form></div></div>
    <div id="print-invoice-modal" class="modal-overlay"><div class="modal-content text-center"><h2 class="text-xl font-bold mb-4">Bill Generated Successfully!</h2><p class="text-gray-600">Do you want to print the invoice?</p><div class="mt-6 flex justify-center gap-4"><button type="button" id="confirm-print-no" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-md cancel-btn">No</button><button type="button" id="confirm-print-yes" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md">Yes, Print</button></div></div></div>
    <div id="add-stock-modal" class="modal-overlay"><div class="modal-content"><h2 class="text-xl font-bold mb-4">Add Stock</h2><div class="space-y-4"><div><label for="add-stock-sku" class="block text-sm font-medium">Enter SKU</label><div class="flex items-center gap-2 mt-1"><input type="text" id="add-stock-sku" class="block w-full rounded-md p-2"><button id="check-stock-sku-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Check</button></div></div><div id="add-stock-product-info" class="hidden p-4 bg-gray-50 rounded-md space-y-3 border border-gray-300"><div><span class="font-medium text-gray-600">Product Name:</span> <span id="add-stock-pname" class="font-bold text-gray-800"></span></div><div><span class="font-medium text-gray-600">Available Qty:</span> <span id="add-stock-avail-qty" class="font-bold text-gray-800"></span></div><hr class="border-gray-300"><div><label for="add-stock-quantity" class="block text-sm font-medium text-gray-700">Quantity to Add</label><input type="number" id="add-stock-quantity" min="1" class="mt-1 block w-full rounded-md p-2"></div></div></div><div class="mt-6 flex justify-end gap-3"><button type="button" id="cancel-add-stock" class="bg-gray-300 py-2 px-4 rounded-md cancel-btn">Cancel</button><button type="button" id="save-add-stock-btn" class="bg-green-600 text-white py-2 px-4 rounded-md">Save Stock</button></div></div></div>
<div id="delete-user-modal" class="modal-overlay">
        <div class="modal-content text-center">
            <h2 class="text-xl font-bold mb-4 text-red-600">Delete User</h2>
            <p class="text-gray-600 mb-4">Are you sure you want to delete user: <strong id="delete-username-display"></strong>?</p>
            <input type="hidden" id="delete-username-hidden">
            <div class="mt-6 flex justify-center gap-4">
                <button type="button" id="cancel-delete-user" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-md cancel-btn">Cancel</button>
                <button type="button" id="confirm-delete-user" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-md">Yes, Delete</button>
            </div>
        </div>
    </div>
<script>
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzOj1fMjodE9eQflDPOmkaYY7S3kEjl7qxZE7ZHWvWlRK5v0RZk7Xi04lpQfz0M72E/exec';
    
    var ALL_PRODUCTS = [], ALL_CUSTOMERS = [], ALL_SALES = [], ALL_BRANDS = [], SALE_LIST_ITEMS = [], BARCODE_PRINT_LIST = [], RETURN_QUEUE = [], LATEST_RECEIPT_DATA = null;
    var state = { 
        products: { limit: 50, filtered: [] }, 
        stock: { limit: 50, filtered: [] }, 
        customers: { limit: 50, filtered: [] }, 
        brands: { limit: 50, filtered: [] } 
    };
    var serverState = { sales: { offset: 0, limit: 50, total: 0, hasMore: true } };

    async function callAppsScript(action, payload) {
        const silentActions = ['checkLogin', 'getCustomerHistory', 'checkLicense', 'getInitialData', 'getDashboardData', 'processSale', 'getProductsForBarcode', 'getCustomersDataList', 'addNewCustomer', 'addNewBrand', 'getReturnableInvoiceDetails', 'processReturn', 'getUsers', 'changePassword', 'addUser', 'deleteUser', 'getSalesDataList', 'getAllSalesForCSV', 'addStockQuantity', 'updateProduct', 'updateCustomer', 'addNewProduct', 'updateBrand', 'findInvoice'];
        
        if (!silentActions.includes(action)) showLoader();
        try {
            const response = await fetch(WEB_APP_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ action: action, payload: payload }), redirect: 'follow' });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const result = await response.json();
            
            if (!silentActions.includes(action)) hideLoader();
            return result;
        } catch (error) {
            if (!silentActions.includes(action)) hideLoader();
            onFailure({ message: `Network or server call failed: ${error.message}` });
            throw error; 
        }
    }

    var loader = document.getElementById('loader-overlay'), pages = document.querySelectorAll('.page'), sidebarItems = document.querySelectorAll('.sidebar-item');
    
    document.addEventListener('DOMContentLoaded', function() { 
        if (window.location.search.length > 0) {
            var cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + window.location.hash;
            window.history.replaceState({}, document.title, cleanUrl);
        }
        initDarkMode(); 
        var now = new Date(); var day = ("0" + now.getDate()).slice(-2); var month = ("0" + (now.getMonth() + 1)).slice(-2);
        document.getElementById('sales-to-date').value = now.getFullYear() + "-" + month + "-" + day;
        
        if (sessionStorage.getItem('isLoggedIn') === 'true') { 
            document.getElementById('login-screen').style.display = 'none'; 
            checkLicense();
        } else { 
            document.getElementById('login-form').addEventListener('submit', handleLogin); 
        } 
        setupLicenseListeners();
    });

    async function handleLogin(e) { 
        e.preventDefault(); 
        var btn = e.target.querySelector('button'); 
        btn.disabled = true; 
        btn.innerHTML = '<div class="btn-loader"></div>';
        var c = { username: document.getElementById('username').value, password: document.getElementById('password').value }; 
        try {
            const r = await callAppsScript('checkLogin', c);
            btn.disabled = false; btn.textContent = "Login";
            
            if (r.success) { 
                sessionStorage.setItem('isLoggedIn', 'true'); 
                sessionStorage.setItem('username', r.username);
                sessionStorage.setItem('role', r.role);
                document.getElementById('login-screen').style.display = 'none'; 
                
                document.getElementById('main-app').classList.remove('hidden');
                startApp();
                checkLicense();
                
                if (!isCustomersLoaded) {
                    callAppsScript('getCustomersDataList').then(res => { if(res.success) { ALL_CUSTOMERS = res.customers || []; isCustomersLoaded = true; } }).catch(e=>{});
                }
            } else { 
                var err = document.getElementById('login-error'); 
                err.textContent = r.message || 'Login failed.'; 
                setTimeout(function() { err.textContent = ''; }, 3000); 
            } 
        } catch(error) { btn.disabled = false; btn.textContent = "Login"; }
    }

    async function checkLicense() {
        const res = await callAppsScript('checkLicense');
        handleLicenseResponse(res);
    }

    function handleLicenseResponse(res) {
        if (!res || !res.success) {
            hideLoader();
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('login-error').textContent = res ? res.message : 'License check failed.';
            sessionStorage.removeItem('isLoggedIn');
            return;
        }
        if (res.status === 'Expired' || res.status === 'Pending') {
            hideLoader();
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('license-lock-overlay').style.display = 'flex';
            document.getElementById('license-lock-overlay').classList.remove('hidden');
            if (res.status === 'Pending') { showPendingState(); startPolling(); }
        } else if (res.status === 'Active') {
            if (res.daysRemaining <= 7) {
                document.getElementById('warning-text').innerText = `আপনার লাইসেন্সের মেয়াদ শেষ হতে আর ${res.daysRemaining} দিন বাকি আছে।`;
                document.getElementById('license-warning-modal').style.display = 'flex';
            }
            document.getElementById('main-app').classList.remove('hidden');
            startApp();
        }
    }

    function setupLicenseListeners() {
        const submitBtn = document.getElementById('submit-payment-btn');
        if(submitBtn) {
            submitBtn.addEventListener('click', async function() {
                const trx = document.getElementById('trx-input').value.trim();
                const amount = document.getElementById('payment-amount-fixed').value;
                if (!trx) return alert('Transaction ID required');
                const btn = document.getElementById('submit-payment-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<div class="btn-loader"></div>'; btn.disabled = true;
                const res = await callAppsScript('submitLicensePayment', { trx: trx, amount: amount });
                if (res.success) { showPendingState(); startPolling(); } 
                else { alert(res.message); btn.innerHTML = originalText; btn.disabled = false; }
            });
        }
        const closeWarningBtn = document.getElementById('close-warning-btn');
        if(closeWarningBtn) closeWarningBtn.addEventListener('click', function() { document.getElementById('license-warning-modal').style.display = 'none'; });
    }

    function showPendingState() {
        document.getElementById('payment-details').classList.add('hidden');
        document.getElementById('payment-pending-msg').classList.remove('hidden');
    }

    let pollingInterval;
    function startPolling() {
        if(pollingInterval) clearInterval(pollingInterval);
        pollingInterval = setInterval(async () => {
            try {
                const response = await fetch(WEB_APP_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ action: 'checkLicense' }) });
                const res = await response.json();
                if (res.success && res.status === 'Active') {
                    clearInterval(pollingInterval);
                    document.querySelector('#payment-pending-msg h3').classList.add('hidden');
                    document.querySelector('#payment-pending-msg .loader').classList.add('hidden');
                    document.getElementById('wait-msg').classList.add('hidden');
                    document.getElementById('payment-success-msg').classList.remove('hidden');
                }
            } catch(e) {}
        }, 10000); 
    }

    var isAppStarted = false;
    async function startApp() {
        if (isAppStarted) return;
        isAppStarted = true;
        
        sidebarItems.forEach(function(i) { i.addEventListener('click', function(e) { e.preventDefault(); navigateTo(i.getAttribute('href').substring(1)); }); });
        navigateTo(window.location.hash ? window.location.hash.substring(1) : 'dashboard'); 
        setupEventListeners();
        if(typeof setupTableDelegation === 'function') setupTableDelegation(); 
        try {
            const data = await callAppsScript('getInitialData');
            onInitialDataSuccess(data);
            callAppsScript('getCustomerHistory').then(res => { if (res.success) ALL_HISTORY_DATA = res.history; }).catch(e => console.log(e));
        } catch(error) {}
    }

    function onInitialDataSuccess(data) { 
        if (data.error || !data.success && data.message) return onFailure({ message: data.error || data.message });
        ALL_PRODUCTS = data.stock || []; ALL_BRANDS = data.brands || []; 
        populateAllData(); updateDashboard(data.dashboard); hideLoader();
    }
    
    function populateAllData() { 
        populateProductTable(ALL_PRODUCTS); populateStockTable(ALL_PRODUCTS); populateBrandTable(ALL_BRANDS); 
    }

    var isSalesLoaded = false;
    var isCustomersLoaded = false;

    async function navigateTo(pageId) { 
        pages.forEach(function(p) { p.classList.toggle('active', p.id === pageId); });
        sidebarItems.forEach(function(i) { i.classList.toggle('active', i.getAttribute('href') === '#' + pageId); }); 
        window.location.hash = pageId;
        
        if(pageId === 'dashboard') { try { const d = await callAppsScript('getDashboardData'); updateDashboard(d); } catch(error) {} }
        
        if(pageId === 'sales' && !isSalesLoaded) {
            var salesBody = document.getElementById('sales-list-body');
            salesBody.innerHTML = '<tr><td colspan="10" class="text-center py-12"><div class="btn-loader border-indigo-500 border-t-transparent mb-3" style="border-color:#e5e7eb; border-top-color:#4f46e5; width:40px; height:40px; border-width:4px;"></div><p class="text-gray-500 font-medium">Loading sales history...</p></td></tr>';
            try { 
                serverState.sales.offset = 0;
                const res = await callAppsScript('getSalesDataList', { offset: 0, limit: 50 }); 
                if(res.success) { 
                    ALL_SALES = res.sales || []; 
                    serverState.sales.total = res.total;
                    serverState.sales.hasMore = ALL_SALES.length < res.total;
                    renderServerSalesTable(ALL_SALES); 
                    isSalesLoaded = true; 
                } 
                else { salesBody.innerHTML = '<tr><td colspan="10" class="text-center py-4 text-red-500">Failed to load</td></tr>'; } 
            } catch(e){ salesBody.innerHTML = '<tr><td colspan="10" class="text-center py-4 text-red-500">Error loading data</td></tr>'; }
        }
        
        if(pageId === 'customers' && !isCustomersLoaded) {
            var custBody = document.getElementById('customer-list-body');
            custBody.innerHTML = '<tr><td colspan="4" class="text-center py-12"><div class="btn-loader border-indigo-500 border-t-transparent mb-3" style="border-color:#e5e7eb; border-top-color:#4f46e5; width:40px; height:40px; border-width:4px;"></div><p class="text-gray-500 font-medium">Loading customers...</p></td></tr>';
            try { 
                const res = await callAppsScript('getCustomersDataList'); 
                if(res.success) { ALL_CUSTOMERS = res.customers || []; populateCustomerTable(ALL_CUSTOMERS); isCustomersLoaded = true; } 
                else { custBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-red-500">Failed to load</td></tr>'; } 
            } catch(e){ custBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-red-500">Error loading data</td></tr>'; }
        }
        
        if(pageId === 'settings') {
            if (sessionStorage.getItem('role') === 'Admin') {
                document.getElementById('admin-user-management').classList.remove('hidden');
                loadUsers();
            } else {
                document.getElementById('admin-user-management').classList.add('hidden');
            }
        }
    }

    function showLoader() { loader.style.display = 'flex'; }
    function hideLoader() { loader.style.display = 'none'; }
    function initDarkMode() { 
        var t = document.getElementById('dark-mode-toggle');
        if (localStorage.getItem('darkMode') === 'enabled') { document.documentElement.classList.add('dark'); t.querySelector('span').classList.add('dark:translate-x-6'); } 
        t.addEventListener('click', function() { document.documentElement.classList.toggle('dark'); t.querySelector('span').classList.toggle('dark:translate-x-6'); localStorage.setItem('darkMode', document.documentElement.classList.contains('dark') ? 'enabled' : 'disabled'); });
    }

    function setupEventListeners() {
        document.getElementById('add-product-form').addEventListener('submit', handleAddProduct);
        document.getElementById('product-search').addEventListener('input', function(e) { populateProductTable(filterData(ALL_PRODUCTS, e.target.value, [0, 1])); });
        document.getElementById('stock-search').addEventListener('input', function(e) { populateStockTable(filterData(ALL_PRODUCTS, e.target.value, [0, 1])); });
        document.getElementById('customer-search').addEventListener('input', function(e) { populateCustomerTable(filterData(ALL_CUSTOMERS, e.target.value, [0, 1])); });
        document.getElementById('show-report-btn').addEventListener('click', handleShowSalesReport);
        document.getElementById('sales-search').addEventListener('input', handleShowSalesReport);
        document.getElementById('bill-sku').addEventListener('keydown', handleSkuEnter);
        document.getElementById('bill-sale-qty').addEventListener('keydown', handleSaleQtyEnter);
        document.getElementById('add-bill-item-btn').addEventListener('click', function(e) { e.preventDefault(); processBillAction(); });
        document.getElementById('check-cust-btn').addEventListener('click', performCustomerSearch);
        var phoneInput = document.getElementById('cust-phone');
        phoneInput.addEventListener('keydown', function(e) { if (e.key === 'Enter') { e.preventDefault(); performCustomerSearch(); } });
        phoneInput.addEventListener('input', function(e) {
            var val = e.target.value.replace(/\D/g, ''); if (val.startsWith('880')) val = val.substring(2);
            if (val.length > 11) val = val.slice(0, 11); e.target.value = val;
            if (val.length === 11) { e.target.classList.remove('border-gray-300', 'dark:border-gray-600', 'border-red-500', 'dark:border-red-400', 'ring-red-500', 'dark:ring-red-400'); e.target.classList.add('border-green-500', 'dark:border-green-400', 'ring-1', 'ring-green-500', 'dark:ring-green-400', 'border-2'); } 
            else { e.target.classList.remove('border-green-500', 'dark:border-green-400', 'ring-green-500', 'dark:ring-green-400', 'border-gray-300', 'dark:border-gray-600'); e.target.classList.add('border-red-500', 'dark:border-red-400', 'ring-1', 'ring-red-500', 'dark:ring-red-400', 'border-2'); }
        });
        
        document.getElementById('discount-value').addEventListener('input', updateBillingSummary);
        document.getElementById('discount-type').addEventListener('change', updateBillingSummary);
        document.getElementById('shipping-charges').addEventListener('input', updateBillingSummary);
        document.getElementById('payment-amount').addEventListener('input', updateBillingSummary);
        document.getElementById('bill-now-btn').addEventListener('click', handleBillNow);
        document.getElementById('new-customer-form').addEventListener('submit', handleSaveNewCustomer);
        document.getElementById('cancel-add-customer').addEventListener('click', function() { document.getElementById('add-customer-modal').style.display = 'none'; });
        document.getElementById('reprint-btn').addEventListener('click', handleReprint);
        document.getElementById('reprint-invoice-id').addEventListener('keydown', function(e) { if (e.key === 'Enter') handleReprint(); });
        document.getElementById('return-invoice-id').addEventListener('keydown', function(e) { if(e.key === 'Enter') handleFindInvoiceForReturn(); });
        document.getElementById('check-invoice-btn').addEventListener('click', handleFindInvoiceForReturn);
        document.getElementById('return-qty-form').addEventListener('submit', handleAddToReturnQueue);
        document.getElementById('process-return-list-btn').addEventListener('click', handleProcessReturnList);
        document.getElementById('cancel-return-qty').addEventListener('click', function() { document.getElementById('return-qty-modal').style.display = 'none'; });
        document.getElementById('add-to-print-btn').addEventListener('click', handleAddToPrintQueue);
        document.getElementById('generate-barcode-btn').addEventListener('click', handleGenerateBarcodes);
        document.getElementById('confirm-print-yes').addEventListener('click', function() { if (LATEST_RECEIPT_DATA) { printInvoice(LATEST_RECEIPT_DATA); } document.getElementById('print-invoice-modal').style.display = 'none'; });
        document.getElementById('confirm-print-no').addEventListener('click', function() { document.getElementById('print-invoice-modal').style.display = 'none'; });
        document.getElementById('add-brand-form').addEventListener('submit', handleAddBrand);
        document.getElementById('brand-search').addEventListener('input', function(e) { populateBrandTable(ALL_BRANDS.filter(function(b){ return b.toLowerCase().includes(e.target.value.toLowerCase()); })); });
        
        document.getElementById('load-more-products').addEventListener('click', function() { state.products.limit += 50; populateProductTable(state.products.filtered, false); });
        document.getElementById('load-more-stock').addEventListener('click', function() { state.stock.limit += 50; populateStockTable(state.stock.filtered, false); });
        document.getElementById('load-more-customers').addEventListener('click', function() { state.customers.limit += 50; populateCustomerTable(state.customers.filtered, false); });
        
        document.getElementById('load-more-sales').addEventListener('click', async function() {
            var btn = this; var oldTxt = btn.innerHTML;
            btn.innerHTML = '<div class="btn-loader border-indigo-500 border-t-transparent" style="border-color:#e5e7eb; border-top-color:#4f46e5;"></div>'; btn.disabled = true;
            serverState.sales.offset += serverState.sales.limit;
            var payload = { offset: serverState.sales.offset, limit: serverState.sales.limit, searchTerm: document.getElementById('sales-search').value, fromDate: document.getElementById('sales-from-date').value, toDate: document.getElementById('sales-to-date').value };
            try { const res = await callAppsScript('getSalesDataList', payload); if(res.success) { ALL_SALES = ALL_SALES.concat(res.sales || []); serverState.sales.hasMore = ALL_SALES.length < res.total; renderServerSalesTable(ALL_SALES); } } catch(e) {}
            btn.innerHTML = oldTxt; btn.disabled = false;
        });

        document.getElementById('load-more-brands').addEventListener('click', function() { state.brands.limit += 50; populateBrandTable(state.brands.filtered, false); });

        document.getElementById('download-sales-btn').addEventListener('click', async function() {
            var btn = this; var oldTxt = btn.innerHTML;
            btn.innerHTML = '<div class="btn-loader"></div>'; btn.disabled = true;
            try {
                const res = await callAppsScript('getAllSalesForCSV', { searchTerm: document.getElementById('sales-search').value, fromDate: document.getElementById('sales-from-date').value, toDate: document.getElementById('sales-to-date').value });
                if(res.success && res.sales && res.sales.length > 0) {
                    var headers = ['Invoice NO', 'Sale Date', 'Customer', 'Phone', 'Address', 'Due', 'Discount', 'Payment', 'Qty', 'Products'];
                    downloadCsvFromArray('sales-report.csv', headers, res.sales, function(s) { return [s[0], s[1], s[2], '="'+(s[3]||'')+'"', s[4], (s[6] || '0.00'), s[5], (s[9] || '0.00'), s[7], s[8]]; });
                } else { showToast('No data to download.', 'error'); }
            } catch(e) { showToast('Download failed.', 'error'); }
            btn.innerHTML = oldTxt; btn.disabled = false;
        });

        document.getElementById('download-stock-btn').addEventListener('click', function() {
            var headers = ['SKU', 'Product Name', 'Brand', 'Purchase Price', 'MRP', 'Purchased Qty', 'Available Qty', 'Sold Qty'];
            downloadCsvFromArray('stock-report.csv', headers, state.stock.filtered, function(p) {
                return [p[0], p[1], (p[7] || ''), p[2], p[3], p[4], p[5], p[6]];
            });
        });

        var brandInput = document.getElementById('new-pbrand');
        var suggestionsContainer = document.getElementById('brand-suggestions');
        brandInput.addEventListener('input', function() {
            var query = brandInput.value.toLowerCase(); suggestionsContainer.innerHTML = '';
            if (query) {
                var filtered = ALL_BRANDS.filter(function(b) { return b.toLowerCase().includes(query); });
                if (filtered.length) {
                    suggestionsContainer.style.display = 'block';
                    filtered.forEach(function(brand) {
                        var div = document.createElement('div'); div.textContent = brand; div.className = 'p-2 cursor-pointer suggestion-item';
                        div.onclick = function() { brandInput.value = brand; suggestionsContainer.style.display = 'none'; }; suggestionsContainer.appendChild(div);
                    });
                } else { suggestionsContainer.style.display = 'none'; }
            } else { suggestionsContainer.style.display = 'none'; }
        });
        document.addEventListener('click', function(e){ if (!brandInput.contains(e.target) && !suggestionsContainer.contains(e.target)) { suggestionsContainer.style.display = 'none'; } });
        
        document.getElementById('add-stock-btn').addEventListener('click', openAddStockModal);
        document.getElementById('check-stock-sku-btn').addEventListener('click', handleCheckStockSku);
        document.getElementById('add-stock-sku').addEventListener('keydown', function(e) { if(e.key === 'Enter') { e.preventDefault(); handleCheckStockSku(); } });
        document.getElementById('save-add-stock-btn').addEventListener('click', handleSaveStock);
        document.getElementById('cancel-add-stock').addEventListener('click', closeAddStockModal);

        document.getElementById('change-password-form').addEventListener('submit', handleChangePassword);
        document.getElementById('add-user-form').addEventListener('submit', handleAddUser);
    }

    async function handleChangePassword(e) {
        e.preventDefault();
        var oldP = document.getElementById('old-password').value;
        var newP = document.getElementById('new-password').value;
        var conP = document.getElementById('confirm-password').value;

        if (newP !== conP) {
            return showToast("New passwords do not match!", "error");
        }
        
        var btn = e.target.querySelector('button[type="submit"]');
        var oldBtnText = btn.innerHTML;
        btn.innerHTML = '<div class="btn-loader"></div>'; btn.disabled = true;

        var payload = { username: sessionStorage.getItem('username'), oldPassword: oldP, newPassword: newP };
        try {
            const res = await callAppsScript('changePassword', payload);
            btn.innerHTML = oldBtnText; btn.disabled = false;
            if(res.success){
                showToast("Password changed successfully!", "success");
                e.target.reset();
            } else {
                showToast(res.message, "error");
            }
        } catch(err) { btn.innerHTML = oldBtnText; btn.disabled = false; }
    }

    async function handleAddUser(e) {
        e.preventDefault();
        var u = document.getElementById('new-username').value;
        var p = document.getElementById('new-user-password').value;
        
        var btn = e.target.querySelector('button[type="submit"]');
        var oldBtnText = btn.innerHTML;
        btn.innerHTML = '<div class="btn-loader"></div>'; btn.disabled = true;

        try {
            const res = await callAppsScript('addUser', {username: u, password: p});
            btn.innerHTML = oldBtnText; btn.disabled = false;
            if(res.success){
                showToast("User added successfully!", "success");
                e.target.reset();
                loadUsers(); 
            } else {
                showToast(res.message, "error");
            }
        } catch(err) { btn.innerHTML = oldBtnText; btn.disabled = false; }
    }

    async function loadUsers() {
        var tbody = document.getElementById('user-list-body');
        tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4"><div class="btn-loader border-indigo-500 border-t-transparent" style="border-color:#e5e7eb; border-top-color:#4f46e5;"></div></td></tr>';
        try {
            const res = await callAppsScript('getUsers');
            if(res.success){
                tbody.innerHTML = res.users.map(function(user) {
                    var deleteBtn = `<button class="text-red-600 hover:text-red-900 font-bold ml-2 delete-user-btn" data-username="${user.username}">Delete</button>`;
                    if(user.role === 'Admin') deleteBtn = `<span class="text-gray-400 text-xs font-bold ml-2">Cannot Delete</span>`;
                    return `<tr><td class="px-3 py-2 text-sm">${user.username}</td><td class="px-3 py-2 text-sm font-bold text-gray-500">${user.role}</td><td class="px-3 py-2 text-sm">${deleteBtn}</td></tr>`;
                }).join('');

                tbody.querySelectorAll('.delete-user-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        document.getElementById('delete-username-display').textContent = this.dataset.username;
                        document.getElementById('delete-username-hidden').value = this.dataset.username;
                        document.getElementById('delete-user-modal').style.display = 'flex';
                    });
                });
            } else { tbody.innerHTML = '<tr><td colspan="3" class="text-center text-red-500 py-4">Failed to load</td></tr>'; }
        } catch(err) { tbody.innerHTML = '<tr><td colspan="3" class="text-center text-red-500 py-4">Error loading data</td></tr>'; }
    }
        document.getElementById('cancel-delete-user').addEventListener('click', function() {
            document.getElementById('delete-user-modal').style.display = 'none';
        });

        document.getElementById('confirm-delete-user').addEventListener('click', async function() {
            var username = document.getElementById('delete-username-hidden').value;
            
            var btn = this;
            var oldBtnText = btn.innerHTML;
            btn.innerHTML = '<div class="btn-loader"></div>'; btn.disabled = true;

            try {
                const delRes = await callAppsScript('deleteUser', { username: username });
                btn.innerHTML = oldBtnText; btn.disabled = false;
                document.getElementById('delete-user-modal').style.display = 'none';
                
                if(delRes.success) { 
                    showToast(delRes.message, "success"); 
                    loadUsers(); 
                } else {
                    showToast(delRes.message, "error");
                }
            } catch(err) { 
                btn.innerHTML = oldBtnText; btn.disabled = false; 
                document.getElementById('delete-user-modal').style.display = 'none';
            }
        });

    function openAddStockModal() { document.getElementById('add-stock-modal').style.display = 'flex'; document.getElementById('add-stock-sku').focus(); }
    function closeAddStockModal() { document.getElementById('add-stock-modal').style.display = 'none'; document.getElementById('add-stock-sku').value = ''; document.getElementById('add-stock-quantity').value = ''; document.getElementById('add-stock-product-info').classList.add('hidden'); }
    function handleCheckStockSku() { var sku = document.getElementById('add-stock-sku').value.trim(); if (!sku) return; var product = ALL_PRODUCTS.find(function(p) { return p[0].toString() === sku; }); var infoDiv = document.getElementById('add-stock-product-info'); if (product) { document.getElementById('add-stock-pname').textContent = product[1]; document.getElementById('add-stock-avail-qty').textContent = product[5]; infoDiv.classList.remove('hidden'); document.getElementById('add-stock-quantity').focus(); } else { showToast('Product not found.', 'error'); infoDiv.classList.add('hidden'); } }
    
    async function handleSaveStock() {
        var sku = document.getElementById('add-stock-sku').value.trim();
        var quantityInput = document.getElementById('add-stock-quantity');
        var quantity = parseInt(quantityInput.value, 10);
        if (!sku || !document.getElementById('add-stock-pname').textContent) return showToast('Please check a valid SKU first.', 'error');
        if (!quantity || quantity <= 0) return showToast('Please enter a valid quantity greater than 0.', 'error');
        
        var btn = document.getElementById('save-add-stock-btn');
        var oldBtnText = btn.innerHTML;
        btn.innerHTML = '<div class="btn-loader"></div>'; btn.disabled = true;

        try {
            const res = await callAppsScript('addStockQuantity', { sku: sku, quantity: quantity });
            btn.innerHTML = oldBtnText; btn.disabled = false;
            
            if (res.success) {
                showToast(res.message, 'success');
                var productIndex = ALL_PRODUCTS.findIndex(function(p) { return p[0].toString() === res.updatedProduct[0].toString(); });
                if (productIndex > -1) ALL_PRODUCTS[productIndex] = res.updatedProduct;
                populateStockTable(ALL_PRODUCTS); closeAddStockModal();
            } else onFailure(res);
        } catch (e) {
            btn.innerHTML = oldBtnText; btn.disabled = false;
        }
    }

    function updateDashboard(data) { document.getElementById('today-sales').textContent = data.todaysSales || '0.00'; document.getElementById('month-sales').textContent = data.monthsSales || '0.00'; document.getElementById('today-qty').textContent = data.todaysSaleQty || '0'; }
    
    function populateProductTable(products, reset = true) { 
        if(reset) { state.products.limit = 50; state.products.filtered = [...products].reverse(); }
        var visibleData = state.products.filtered.slice(0, state.products.limit);
        
        var datalistId = 'brand-list-options'; var datalist = document.getElementById(datalistId);
        if (!datalist) { datalist = document.createElement('datalist'); datalist.id = datalistId; document.body.appendChild(datalist); }
        datalist.innerHTML = ALL_BRANDS.map(function(b) { return `<option value="${b}">`; }).join('');
        
        var tbody = document.getElementById('product-list-body'); 
        tbody.innerHTML = visibleData.map(function(p) { 
            return `<tr data-sku="${p[0]}"><td class="py-2 pl-4 pr-3 text-sm font-bold">${p[0]}</td><td class="px-3 py-2 text-sm"><input type="text" value="${p[1]}" class="w-full bg-transparent p-1 customer-edit-input prod-edit-name" readonly></td><td class="px-3 py-2 text-sm"><input type="text" value="${p[7] || ''}" list="${datalistId}" class="w-full bg-transparent p-1 customer-edit-input prod-edit-brand" readonly placeholder="Brand"></td><td class="px-3 py-2 text-sm"><input type="number" value="${p[2]}" class="w-20 bg-transparent p-1 customer-edit-input prod-edit-pprice" readonly></td><td class="px-3 py-2 text-sm"><input type="number" value="${p[3]}" class="w-20 bg-transparent p-1 customer-edit-input prod-edit-mrp" readonly></td><td class="px-3 py-2 text-sm flex gap-2"><button class="text-indigo-600 hover:text-indigo-900 font-bold edit-prod-btn">Edit</button><button class="text-green-600 hover:text-green-900 font-bold save-prod-btn hidden">Save</button><button class="text-red-500 hover:text-red-700 font-bold cancel-prod-btn hidden">X</button></td></tr>`; 
        }).join(''); 
        
        tbody.querySelectorAll('.edit-prod-btn').forEach(function(btn) { 
            btn.addEventListener('click', function(e) {
                var row = e.target.closest('tr');
                row.querySelectorAll('input').forEach(function(input) { input.readOnly = false; });
                row.querySelector('.edit-prod-btn').classList.add('hidden'); 
                row.querySelector('.save-prod-btn').classList.remove('hidden'); 
                row.querySelector('.cancel-prod-btn').classList.remove('hidden');
            }); 
        });
        tbody.querySelectorAll('.save-prod-btn').forEach(function(btn) { 
            btn.addEventListener('click', async function(e) {
                var row = e.target.closest('tr'); var sku = row.dataset.sku; var name = row.querySelector('.prod-edit-name').value.trim(); var brand = row.querySelector('.prod-edit-brand').value.trim(); var pPrice = row.querySelector('.prod-edit-pprice').value; var mrp = row.querySelector('.prod-edit-mrp').value;
                if (brand !== "" && !ALL_BRANDS.includes(brand)) { showToast('Error: Brand not found in list.', 'error'); row.querySelector('.prod-edit-brand').focus(); return; }
                if (!name || !pPrice || !mrp) return showToast('Name, Price and MRP cannot be empty.', 'error');
                var saveBtn = row.querySelector('.save-prod-btn'); var oldText = saveBtn.innerHTML; saveBtn.innerHTML = '<div class="btn-loader" style="width: 16px; height: 16px; border-width: 2px; border-top-color: #16a34a;"></div>'; saveBtn.disabled = true;
                try {
                    const res = await callAppsScript('updateProduct', { sku: sku, name: name, brand: brand, purchasePrice: pPrice, mrp: mrp });
                    if (res.success) {
                        showToast('Product Updated!', 'success');
                        var idx = ALL_PRODUCTS.findIndex(function(p) { return p[0].toString() === sku; });
                        if (idx > -1) { ALL_PRODUCTS[idx][1] = name; ALL_PRODUCTS[idx][2] = pPrice; ALL_PRODUCTS[idx][3] = mrp; ALL_PRODUCTS[idx][7] = brand; }
                        populateProductTable(ALL_PRODUCTS); 
                    } else { showToast(res.message, 'error'); saveBtn.innerHTML = oldText; saveBtn.disabled = false; }
                } catch (err) { saveBtn.innerHTML = oldText; saveBtn.disabled = false; }
            }); 
        });
        tbody.querySelectorAll('.cancel-prod-btn').forEach(function(btn) { btn.addEventListener('click', function() { populateProductTable(ALL_PRODUCTS); }); });

        var loadMoreBtn = document.getElementById('load-more-products');
        if(loadMoreBtn) loadMoreBtn.classList.toggle('hidden', state.products.filtered.length <= state.products.limit);
    }

    function populateStockTable(products, reset = true) { 
        if(reset) { state.stock.limit = 50; state.stock.filtered = [...products].reverse(); }
        var visibleData = state.stock.filtered.slice(0, state.stock.limit);
        var tbody = document.getElementById('stock-list-body'); 
        tbody.innerHTML = visibleData.map(function(p) { var qtyClass = parseInt(p[5]) <= 5 ? 'text-red-600 font-bold' : ''; return `<tr><td class="py-2 pl-4 pr-3 text-sm">${p[0]}</td><td class="px-3 py-2 text-sm">${p[1]}</td><td class="px-3 py-2 text-sm">${p[7] || ''}</td><td class="px-3 py-2 text-sm">${p[2]}</td><td class="px-3 py-2 text-sm">${p[3]}</td><td class="px-3 py-2 text-sm">${p[4]}</td><td class="px-3 py-2 text-sm ${qtyClass}">${p[5]}</td><td class="px-3 py-2 text-sm">${p[6]}</td></tr>`; }).join(''); 

        var loadMoreBtn = document.getElementById('load-more-stock');
        if(loadMoreBtn) loadMoreBtn.classList.toggle('hidden', state.stock.filtered.length <= state.stock.limit);
    }

    function populateCustomerTable(customers, reset = true) { 
        if(reset) { state.customers.limit = 50; state.customers.filtered = [...customers].reverse(); }
        var visibleData = state.customers.filtered.slice(0, state.customers.limit);
        var tbody = document.getElementById('customer-list-body'); 
        tbody.innerHTML = visibleData.map(function(c) { return `<tr data-original-phone="${c[1]}"><td class="py-2 pl-4 pr-3 text-sm"><input type="text" value="${c[0]}" class="w-full bg-transparent p-1 customer-edit-input customer-edit-name" readonly></td><td class="px-3 py-2 text-sm"><input type="text" value="${c[1]}" class="w-full bg-transparent p-1 customer-edit-input customer-edit-phone" readonly></td><td class="px-3 py-2 text-sm"><input type="text" value="${c[2]}" class="w-full bg-transparent p-1 customer-edit-input customer-edit-address" readonly></td><td class="px-3 py-2 text-sm"><button class="text-indigo-600 hover:text-indigo-900 edit-customer-btn">Edit</button><button class="text-green-600 hover:text-green-900 save-customer-btn hidden">Save</button></td></tr>`; }).join(''); 
        tbody.querySelectorAll('.edit-customer-btn').forEach(function(b) { b.addEventListener('click', handleEditCustomer); }); 
        tbody.querySelectorAll('.save-customer-btn').forEach(function(b) { b.addEventListener('click', handleSaveCustomerUpdate); }); 

        var loadMoreBtn = document.getElementById('load-more-customers');
        if(loadMoreBtn) loadMoreBtn.classList.toggle('hidden', state.customers.filtered.length <= state.customers.limit);
    }

    let salesSearchTimeout;
    function handleShowSalesReport() { 
        clearTimeout(salesSearchTimeout);
        salesSearchTimeout = setTimeout(async function() {
            var btn = document.getElementById('show-report-btn');
            var oldTxt = btn.innerHTML;
            btn.innerHTML = '<div class="btn-loader"></div>'; btn.disabled = true;
            
            var from = document.getElementById('sales-from-date').value;
            var to = document.getElementById('sales-to-date').value;
            var term = document.getElementById('sales-search').value;
            
            serverState.sales.offset = 0;
            var payload = { offset: 0, limit: 50, searchTerm: term, fromDate: from, toDate: to };
            
            try {
                const res = await callAppsScript('getSalesDataList', payload);
                if(res.success) {
                    ALL_SALES = res.sales || [];
                    serverState.sales.total = res.total;
                    serverState.sales.hasMore = ALL_SALES.length < res.total;
                    renderServerSalesTable(ALL_SALES);
                }
            } catch(e) {}
            btn.innerHTML = oldTxt; btn.disabled = false;
        }, 500); 
    }

    function renderServerSalesTable(sales) { 
        var tbody = document.getElementById('sales-list-body'); 
        if(sales.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" class="text-center py-6 text-gray-500 font-medium">No sales data found</td></tr>';
        } else {
            tbody.innerHTML = sales.map(function(s) { 
                var textClass = "";
                if (s[10] === "Fully Returned") textClass = "text-red-600 font-bold dark:text-red-400";
                else if (s[10] === "Partial Return") textClass = "text-yellow-600 font-bold dark:text-yellow-400";
                return `<tr class="${textClass}"><td class="py-2 pl-4 pr-3 text-sm">${s[0]}</td><td class="px-3 py-2 text-sm">${s[1]}</td><td class="px-3 py-2 text-sm">${s[2]}</td><td class="px-3 py-2 text-sm">${s[3]}</td><td class="px-3 py-2 text-sm">${s[4]}</td><td class="px-3 py-2 text-sm">${s[6] || '0.00'}</td><td class="px-3 py-2 text-sm">${s[5]}</td><td class="px-3 py-2 text-sm">${s[9] || '0.00'}</td><td class="px-3 py-2 text-sm">${s[7]}</td><td class="px-3 py-2 text-sm">${s[8]}</td></tr>`; 
            }).join(''); 
        }
        var loadMoreBtn = document.getElementById('load-more-sales');
        if(loadMoreBtn) loadMoreBtn.classList.toggle('hidden', !serverState.sales.hasMore);
    }

    function populateBrandTable(brands, reset = true) { 
        if(reset) { state.brands.limit = 50; state.brands.filtered = [...brands].reverse(); }
        var visibleData = state.brands.filtered.slice(0, state.brands.limit);
        var tbody = document.getElementById('brand-list-body'); 
        tbody.innerHTML = visibleData.map(function(b) { return `<tr data-original-brand="${b}"><td class="py-2 pl-4 pr-3 text-sm"><input type="text" value="${b}" class="w-full bg-transparent p-1 brand-edit-input" readonly></td><td class="px-3 py-2 text-sm"><button class="text-indigo-600 hover:text-indigo-900 edit-brand-btn">Edit</button><button class="text-green-600 hover:text-green-900 save-brand-btn hidden">Save</button></td></tr>`; }).join(''); 
        tbody.querySelectorAll('.edit-brand-btn').forEach(function(btn){ btn.addEventListener('click', handleEditBrand); }); 
        tbody.querySelectorAll('.save-brand-btn').forEach(function(btn){ btn.addEventListener('click', handleSaveBrandUpdate); }); 

        var loadMoreBtn = document.getElementById('load-more-brands');
        if(loadMoreBtn) loadMoreBtn.classList.toggle('hidden', state.brands.filtered.length <= state.brands.limit);
    }
    
    async function handleAddProduct(e) { e.preventDefault(); var brandName = document.getElementById('new-pbrand').value.trim(); if (!brandName) { return showToast('Brand Name is required.', 'error'); } if (ALL_BRANDS.indexOf(brandName) === -1) { return showToast('Brand not found. Please add the brand first.', 'error'); } var btn = e.target.querySelector('button[type="submit"]'); var oldBtnText = btn.innerHTML; btn.innerHTML = '<div class="btn-loader"></div>'; btn.disabled = true; var p = { name: document.getElementById('new-pname').value, purchasePrice: document.getElementById('new-pprice').value, mrp: document.getElementById('new-mrp').value, quantity: document.getElementById('new-pqty').value, brand: brandName }; try { const r = await callAppsScript('addNewProduct', p); btn.innerHTML = oldBtnText; btn.disabled = false; if(r.success) { showToast('Product added!', 'success'); ALL_PRODUCTS.push(r.newProduct); populateProductTable(ALL_PRODUCTS); populateStockTable(ALL_PRODUCTS); e.target.reset(); } else { onFailure(r); } } catch(err) { btn.innerHTML = oldBtnText; btn.disabled = false; } }
   function processBillAction() { 
        var skuInput = document.getElementById('bill-sku'); var sku = skuInput.value.trim(); 
        var pNameInput = document.getElementById('bill-pname'); var availQtyInput = document.getElementById('bill-avail-qty'); var saleQtyInput = document.getElementById('bill-sale-qty'); 
        var isAuto = document.getElementById('auto-add-checkbox') ? document.getElementById('auto-add-checkbox').checked : false;
        
        if (!sku) return showToast('Please enter SKU.', 'error'); 
        
        var p = ALL_PRODUCTS.find(function(item) { return item[0].toString() === sku; }); 
        if (!p) { pNameInput.value = ''; availQtyInput.value = ''; saleQtyInput.value = ''; return showToast('Product not found', 'error'); }
        
        var avail = parseInt(p[5]);
        var isFirstStep = !pNameInput.value;
        var qtyToAdd = 1;

        if (!isFirstStep) {
            qtyToAdd = parseInt(saleQtyInput.value);
            if (isNaN(qtyToAdd) || qtyToAdd <= 0) return showToast('Please enter a valid quantity.', 'error');
        }
        if (isFirstStep && !isAuto) {
            pNameInput.value = p[1]; availQtyInput.value = avail; saleQtyInput.value = '1'; saleQtyInput.focus(); saleQtyInput.select();
            return;
        }
        var existingItem = SALE_LIST_ITEMS.find(function(i) { return i.sku.toString() === sku; });
        var currentCartQty = existingItem ? existingItem.quantity : 0;
        if (currentCartQty + qtyToAdd > avail) {
            if (isFirstStep) { pNameInput.value = p[1]; availQtyInput.value = avail; saleQtyInput.focus(); }
            return showToast('Only ' + avail + ' in stock! (' + currentCartQty + ' already in bill)', 'error');
        }

        if (existingItem) {
            existingItem.quantity += qtyToAdd;
            var baseTotal = existingItem.mrp * existingItem.quantity;
            var dAmt = existingItem.itemDiscountType === 'percent' ? (baseTotal * (existingItem.itemDiscount || 0)) / 100 : (existingItem.itemDiscount || 0);
            existingItem.total = Math.max(0, baseTotal - dAmt);
        } else {
            SALE_LIST_ITEMS.push({ sku: p[0], name: p[1], mrp: parseFloat(p[3]), quantity: qtyToAdd, total: parseFloat(p[3]) * qtyToAdd, itemDiscount: 0, itemDiscountType: 'percent' });
        }
        
        renderSaleList(); updateBillingSummary();
        skuInput.value = ''; pNameInput.value = ''; availQtyInput.value = ''; saleQtyInput.value = ''; skuInput.focus();
    }

    function handleSkuEnter(e) { if (e.key === 'Enter') { e.preventDefault(); processBillAction(); } }
    function handleSaleQtyEnter(e) { if (e.key === 'Enter') { e.preventDefault(); processBillAction(); } }
    var ALL_HISTORY_DATA = null;
    var isSearchingCustomer = false;
    async function performCustomerSearch() {
        if (isSearchingCustomer) return;
        var phoneInput = document.getElementById('cust-phone'); var phone = phoneInput.value.trim(); var historyDiv = document.getElementById('cust-history-status');
        if (!phone || phone.length !== 11) return showToast('Please enter a valid 11-digit number.', 'error');
        var sPhone = phone.startsWith('0') ? phone : '0' + phone; 
        
        isSearchingCustomer = true;
        var btn = document.getElementById('check-cust-btn');
        var oldBtnText = btn.innerHTML;
        btn.innerHTML = '<div class="btn-loader" style="width: 16px; height: 16px; border-width: 2px;"></div>'; btn.disabled = true;

        try {
            if (!isCustomersLoaded) {
                const res = await callAppsScript('getCustomersDataList'); 
                if(res.success) { ALL_CUSTOMERS = res.customers || []; isCustomersLoaded = true; } 
            }
            
            var c = ALL_CUSTOMERS.find(function(c) { return c[1] === sPhone; });
            if (ALL_HISTORY_DATA === null) { const res = await callAppsScript('getCustomerHistory'); ALL_HISTORY_DATA = res.success ? res.history : {}; }
            
            if (c) {
                document.getElementById('cust-name').value = c[0]; document.getElementById('cust-address').value = c[2]; historyDiv.classList.remove('hidden'); historyDiv.style.display = "block"; 
                var hist = ALL_HISTORY_DATA[sPhone];
                if (!hist || hist.purchased === 0) historyDiv.innerHTML = `<span style="color: #16a34a;">New Customer</span>`;
                else historyDiv.innerHTML = `<span style="color: #0d9488;">Purchased Qty: ${hist.purchased}</span> | <span style="color: #ea580c;">Partial Delivery Qty: ${hist.partial}</span> | <span style="color: #dc2626;">Return Qty: ${hist.returned}</span>`;
                showToast('Customer Found!', 'success');
            } else {
                historyDiv.classList.remove('hidden'); historyDiv.style.display = "block"; historyDiv.innerHTML = `<span style="color: #16a34a;">New Customer</span>`;
                document.getElementById('new-cust-modal-phone').textContent = phone; document.getElementById('add-customer-modal').style.display = 'flex'; document.getElementById('new-cust-modal-name').focus();
            }
        } catch (e) {
            console.error(e);
        } finally {
            btn.innerHTML = oldBtnText; btn.disabled = false;
            isSearchingCustomer = false;
        }
    }

    async function handleSaveNewCustomer(e) { 
        e.preventDefault(); 
        var btn = e.target.querySelector('button[type="submit"]');
        var oldBtnText = btn.innerHTML;
        btn.innerHTML = '<div class="btn-loader"></div>'; btn.disabled = true;
        var c = { phone: document.getElementById('new-cust-modal-phone').textContent, name: document.getElementById('new-cust-modal-name').value, address: document.getElementById('new-cust-modal-address').value }; 
        try { 
            const r = await callAppsScript('addNewCustomer', c); 
            btn.innerHTML = oldBtnText; btn.disabled = false;
            if (r.success) { showToast('Customer saved!', 'success'); ALL_CUSTOMERS.push(r.newCustomer); populateCustomerTable(ALL_CUSTOMERS); document.getElementById('cust-phone').value = r.newCustomer[1]; document.getElementById('cust-name').value = r.newCustomer[0]; document.getElementById('cust-address').value = r.newCustomer[2]; document.getElementById('add-customer-modal').style.display = 'none'; e.target.reset(); } else { onFailure(r); } 
        } catch(err){ btn.innerHTML = oldBtnText; btn.disabled = false; } 
    }
    
    async function handleBillNow() {
        if (SALE_LIST_ITEMS.length === 0) return showToast('Add items first.', 'error');
        if (!document.getElementById('cust-phone').value) return showToast('Enter customer phone.', 'error');
        
        var btn = document.getElementById('bill-now-btn');
        var oldBtnText = btn.innerHTML;
        btn.innerHTML = '<div class="btn-loader"></div>'; btn.disabled = true;

        var s = calculateBillingSummary();
        var d = { customer: { phone: document.getElementById('cust-phone').value, name: document.getElementById('cust-name').value || 'Walk-in', address: document.getElementById('cust-address').value }, items: SALE_LIST_ITEMS, subtotal: s.subtotal, discount: s.discountString, shipping: s.shipping, total: s.total, paymentAmount: s.paymentAmount, dueAmount: s.dueAmount };
        try {
            const r = await callAppsScript('processSale', d);
            btn.innerHTML = oldBtnText; btn.disabled = false;
            
            if (r.success) {
                ALL_HISTORY_DATA = null;
                LATEST_RECEIPT_DATA = r.receiptData; document.getElementById('print-invoice-modal').style.display = 'flex'; resetBillingPage();
                if (r.updatedStock && r.updatedStock.length > 0) { r.updatedStock.forEach(updatedProduct => { const productIndex = ALL_PRODUCTS.findIndex(p => p[0].toString() === updatedProduct[0].toString()); if (productIndex > -1) { ALL_PRODUCTS[productIndex] = updatedProduct; } }); populateStockTable(ALL_PRODUCTS); populateProductTable(ALL_PRODUCTS); }
                const dashboardData = await callAppsScript('getDashboardData'); updateDashboard(dashboardData);
                if (isSalesLoaded) handleShowSalesReport();
            } else onFailure(r);
        } catch (err) {
            btn.innerHTML = oldBtnText; btn.disabled = false;
        }
    }

    function handleEditCustomer(e) { var row = e.target.closest('tr'); row.querySelectorAll('.customer-edit-input').forEach(function(i) { i.readOnly = false; }); row.querySelector('.edit-customer-btn').classList.add('hidden'); row.querySelector('.save-customer-btn').classList.remove('hidden'); }
    async function handleSaveCustomerUpdate(e) { var row = e.target.closest('tr'); var saveBtn = row.querySelector('.save-customer-btn'); var oldText = saveBtn.innerHTML; saveBtn.innerHTML = '<div class="btn-loader" style="width: 16px; height: 16px; border-width: 2px; border-top-color: #16a34a;"></div>'; saveBtn.disabled = true; var d = { originalPhone: row.dataset.originalPhone, newCustomerData: { name: row.querySelector('.customer-edit-name').value, phone: row.querySelector('.customer-edit-phone').value, address: row.querySelector('.customer-edit-address').value } }; try { const r = await callAppsScript('updateCustomer', d); if (r.success) { showToast(r.message, 'success'); var idx = ALL_CUSTOMERS.findIndex(function(c) { return c[1] === d.originalPhone; }); if (idx > -1) { var newPhone = d.newCustomerData.phone.toString(); if (!newPhone.startsWith('0') && newPhone !== '') newPhone = '0' + newPhone; ALL_CUSTOMERS[idx][0] = d.newCustomerData.name; ALL_CUSTOMERS[idx][1] = newPhone; ALL_CUSTOMERS[idx][2] = d.newCustomerData.address; } populateCustomerTable(ALL_CUSTOMERS); } else { showToast(r.message, 'error'); saveBtn.innerHTML = oldText; saveBtn.disabled = false; } } catch(err) { saveBtn.innerHTML = oldText; saveBtn.disabled = false; } }
    async function handleReprint() { var id = document.getElementById('reprint-invoice-id').value; if (!id) return showToast('Enter invoice number.', 'error'); var btn = document.getElementById('reprint-btn'); var oldBtnText = btn.innerHTML; btn.innerHTML = '<div class="btn-loader" style="width: 16px; height: 16px; border-width: 2px;"></div>'; btn.disabled = true; try { const r = await callAppsScript('findInvoice', id); btn.innerHTML = oldBtnText; btn.disabled = false; if (r.success) printInvoice(r.invoiceData); else onFailure(r); } catch(err){ btn.innerHTML = oldBtnText; btn.disabled = false; } }
    
    async function handleFindInvoiceForReturn() { 
        var id = document.getElementById('return-invoice-id').value; 
        if (!id) return; 
        
        var btn = document.getElementById('check-invoice-btn');
        var oldBtnText = btn.innerHTML;
        btn.innerHTML = '<div class="btn-loader" style="width: 16px; height: 16px; border-width: 2px;"></div>'; btn.disabled = true;

        RETURN_QUEUE = []; renderReturnQueue(); document.getElementById('return-list-container').style.display = 'none'; 
        try { 
            const res = await callAppsScript('getReturnableInvoiceDetails', id); 
            btn.innerHTML = oldBtnText; btn.disabled = false;
            if (res.success) { document.getElementById('return-invoice-display').textContent = '#' + res.invoiceId; var list = document.getElementById('return-product-list'); list.innerHTML = res.products.map(function(p) { var statusClass = p.returnableQty > 0 ? 'bg-red-500 hover:bg-red-600' : 'bg-gray-400 cursor-not-allowed'; var statusText = p.returnableQty > 0 ? 'Return' : 'Returned'; return `<div class="flex justify-between items-center bg-gray-100 p-3 rounded-md"><div><p class="font-semibold">${p.name}</p><p class="text-sm text-gray-500">SKU: ${p.sku} | Sold: ${p.soldQty} | Returned: ${p.returnedQty}</p></div><button id="return-action-btn-${p.sku}" class="text-white px-3 py-1 rounded-md open-return-modal-btn ${statusClass}" data-sku="${p.sku}" data-name="${p.name}" data-invoiceid="${res.invoiceId}" data-max-return="${p.returnableQty}" ${p.returnableQty <= 0 ? 'disabled' : ''}>${statusText}</button></div>`; }).join(''); document.getElementById('return-products-container').style.display = 'block'; list.querySelectorAll('.open-return-modal-btn').forEach(function(b) { b.addEventListener('click', function() { var max = this.dataset.maxReturn; document.getElementById('return-modal-pname').textContent = this.dataset.name; document.getElementById('return-modal-sku').value = this.dataset.sku; document.getElementById('return-modal-invoiceid').value = this.dataset.invoiceid; document.getElementById('return-modal-maxqty').value = max; var qtyInput = document.getElementById('return-modal-qty'); qtyInput.max = max; qtyInput.value = 1; document.getElementById('return-qty-modal').style.display = 'flex'; qtyInput.focus(); }); }); } else onFailure(res); 
        } catch(err){ btn.innerHTML = oldBtnText; btn.disabled = false; } 
    }
    
    function handleAddToReturnQueue(e) { e.preventDefault(); var qty = parseInt(document.getElementById('return-modal-qty').value); var max = parseInt(document.getElementById('return-modal-maxqty').value); if (qty > max) return showToast('Cannot return more than ' + max + ' items.', 'error'); var sku = document.getElementById('return-modal-sku').value; var item = { invoiceId: document.getElementById('return-modal-invoiceid').value, sku: sku, name: document.getElementById('return-modal-pname').textContent, quantity: qty }; RETURN_QUEUE.push(item); var btn = document.getElementById('return-action-btn-' + sku); if (btn) { btn.classList.remove('bg-red-500', 'hover:bg-red-600'); btn.classList.add('bg-gray-400', 'cursor-not-allowed'); btn.textContent = 'Added to List'; btn.disabled = true; } renderReturnQueue(); document.getElementById('return-qty-modal').style.display = 'none'; document.getElementById('return-qty-form').reset(); }
    
    function renderReturnQueue() { var list = document.getElementById('return-queue-list'); if(RETURN_QUEUE.length > 0) { document.getElementById('return-list-container').style.display = 'block'; list.innerHTML = RETURN_QUEUE.map(function(item, index) { return `<li class="text-sm flex justify-between items-center"><span>${item.quantity} x ${item.name}</span><button class="text-red-500 text-xs remove-return-queue-item font-bold" data-index="${index}">REMOVE</button></li>`; }).join(''); list.querySelectorAll('.remove-return-queue-item').forEach(function(btn){ btn.addEventListener('click', function(){ var removedItem = RETURN_QUEUE.splice(this.dataset.index, 1)[0]; var mainBtn = document.getElementById('return-action-btn-' + removedItem.sku); if (mainBtn) { mainBtn.classList.remove('bg-gray-400', 'cursor-not-allowed'); mainBtn.classList.add('bg-red-500', 'hover:bg-red-600'); mainBtn.textContent = 'Return'; mainBtn.disabled = false; } renderReturnQueue(); }); }); } else document.getElementById('return-list-container').style.display = 'none'; }
    
    async function handleProcessReturnList() { 
        if (RETURN_QUEUE.length === 0) return showToast('No items in the return list.', 'error'); 
        
        var btn = document.getElementById('process-return-list-btn');
        var oldBtnText = btn.innerHTML;
        btn.innerHTML = '<div class="btn-loader"></div>'; btn.disabled = true;

        try { 
            const r = await callAppsScript('processReturn', RETURN_QUEUE); 
            btn.innerHTML = oldBtnText; btn.disabled = false;
            if(r.success) { ALL_HISTORY_DATA = null; showToast(r.message, 'success'); document.getElementById('return-invoice-id').value = ''; document.getElementById('return-products-container').style.display = 'none'; RETURN_QUEUE = []; renderReturnQueue(); const data = await callAppsScript('getInitialData'); ALL_PRODUCTS = data.stock; populateStockTable(ALL_PRODUCTS); populateProductTable(ALL_PRODUCTS); if(isSalesLoaded) handleShowSalesReport(); } else onFailure(r); 
        } catch(err) { btn.innerHTML = oldBtnText; btn.disabled = false; } 
    }
    
    function handleAddToPrintQueue() { var sku = document.getElementById('barcode-sku').value; var qty = document.getElementById('barcode-qty').value; if (!sku || !qty || parseInt(qty) < 1) return showToast('Invalid SKU or quantity', 'error'); var p = ALL_PRODUCTS.find(function(p) { return p[0].toString() === sku; }); if (!p) return showToast('Product not found', 'error'); BARCODE_PRINT_LIST.push({sku: sku, quantity: parseInt(qty), name: p[1], price: p[3] }); renderBarcodePrintList(); document.getElementById('barcode-sku').value = ''; document.getElementById('barcode-qty').value = ''; }
    async function handleGenerateBarcodes() { 
        if (BARCODE_PRINT_LIST.length === 0) return showToast('Add items to queue first', 'error'); 
        var btn = document.getElementById('generate-barcode-btn');
        var oldBtnText = btn.innerHTML;
        btn.innerHTML = '<div class="btn-loader"></div>'; btn.disabled = true;
        try { 
            const r = await callAppsScript('getProductsForBarcode', BARCODE_PRINT_LIST); 
            btn.innerHTML = oldBtnText; btn.disabled = false;
            if (r.success) { printBarcodes(r.labels); BARCODE_PRINT_LIST = []; renderBarcodePrintList(); } else onFailure(r); 
        } catch(err) { btn.innerHTML = oldBtnText; btn.disabled = false; } 
    }
    
    async function handleAddBrand(e){ 
        e.preventDefault(); 
        var brandName = document.getElementById('new-brand-name').value.trim(); 
        if(!brandName) return showToast('Brand name is required.', 'error'); 
        var btn = e.target.querySelector('button[type="submit"]');
        var oldBtnText = btn.innerHTML;
        btn.innerHTML = '<div class="btn-loader"></div>'; btn.disabled = true;
        try { 
            const res = await callAppsScript('addNewBrand', brandName); 
            btn.innerHTML = oldBtnText; btn.disabled = false;
            if(res.success){ showToast('Brand added!', 'success'); ALL_BRANDS.push(res.newBrand); populateBrandTable(ALL_BRANDS); e.target.reset(); } else onFailure(res); 
        } catch(err){ btn.innerHTML = oldBtnText; btn.disabled = false; } 
    }
    function handleEditBrand(e){ var row = e.target.closest('tr'); var input = row.querySelector('.brand-edit-input'); input.readOnly = false; input.classList.add('customer-edit-input'); row.querySelector('.edit-brand-btn').classList.add('hidden'); row.querySelector('.save-brand-btn').classList.remove('hidden'); }
    async function handleSaveBrandUpdate(e){ var row = e.target.closest('tr'); var saveBtn = row.querySelector('.save-brand-btn'); var oldText = saveBtn.innerHTML; saveBtn.innerHTML = '<div class="btn-loader" style="width: 16px; height: 16px; border-width: 2px; border-top-color: #16a34a;"></div>'; saveBtn.disabled = true; var data = { originalName: row.dataset.originalBrand, newName: row.querySelector('.brand-edit-input').value }; try { const res = await callAppsScript('updateBrand', data); if(res.success){ showToast(res.message, 'success'); var idx = ALL_BRANDS.indexOf(data.originalName); if (idx > -1) { ALL_BRANDS[idx] = data.newName; } populateBrandTable(ALL_BRANDS); } else { onFailure(res); saveBtn.innerHTML = oldText; saveBtn.disabled = false; } } catch(err) { saveBtn.innerHTML = oldText; saveBtn.disabled = false; } }
    
    function calculateBillingSummary() { var sub = SALE_LIST_ITEMS.reduce(function(s, i) { return s + i.total; }, 0); var dVal = parseFloat(document.getElementById('discount-value').value) || 0; var dType = document.getElementById('discount-type').value; var ship = parseFloat(document.getElementById('shipping-charges').value) || 0; var pay = parseFloat(document.getElementById('payment-amount').value) || 0; var dAmt = 0, dStr = "0"; if (dType === 'percent') { dAmt = (sub * dVal) / 100; dStr = dVal + '%'; } else { dAmt = dVal; dStr = dVal.toString(); } var tot = sub - dAmt + ship; var due = tot - pay; return { subtotal: sub, discountAmount: dAmt, shipping: ship, total: tot, paymentAmount: pay, dueAmount: due, discountString: dStr }; }
    function updateBillingSummary() { checkDiscountExclusivity(); var s = calculateBillingSummary(); document.getElementById('summary-subtotal').textContent = s.subtotal.toFixed(2); document.getElementById('summary-due-amount').textContent = s.dueAmount.toFixed(2); }

function checkDiscountExclusivity() {
    var globalInput = document.getElementById('discount-value'); var globalType = document.getElementById('discount-type'); var itemInputs = document.querySelectorAll('.item-discount-val'); var itemTypes = document.querySelectorAll('.item-discount-type');
    var globalVal = parseFloat(globalInput.value) || 0; var hasItemDiscount = SALE_LIST_ITEMS.some(function(i) { return (parseFloat(i.itemDiscount) || 0) > 0; });
    if (globalVal > 0) {
        itemInputs.forEach(function(el, index) { el.disabled = true; el.value = ''; SALE_LIST_ITEMS[index].itemDiscount = 0; SALE_LIST_ITEMS[index].total = SALE_LIST_ITEMS[index].mrp * SALE_LIST_ITEMS[index].quantity; document.querySelectorAll('.item-total-display')[index].textContent = SALE_LIST_ITEMS[index].total.toFixed(2); });
        itemTypes.forEach(function(el) { el.disabled = true; });
    } else if (hasItemDiscount) {
        globalInput.disabled = true; globalType.disabled = true; globalInput.value = '';
    } else {
        globalInput.disabled = false; globalType.disabled = false; itemInputs.forEach(function(el) { el.disabled = false; }); itemTypes.forEach(function(el) { el.disabled = false; });
    }
}
    function renderBarcodePrintList() { var list = document.getElementById('barcode-print-list'); list.innerHTML = BARCODE_PRINT_LIST.map(function(i, x) { return `<li class="flex justify-between items-center bg-gray-50 p-2 rounded" data-index="${x}"><span>${i.quantity} x ${i.name} (SKU: ${i.sku})</span><button class="text-red-500 remove-barcode-item-btn">X</button></li>`; }).join(''); list.querySelectorAll('.remove-barcode-item-btn').forEach(function(b) { b.addEventListener('click', function(e) { BARCODE_PRINT_LIST.splice(e.target.closest('li').dataset.index, 1); renderBarcodePrintList(); }); }); }
    
    function resetBillingPage() { 
        SALE_LIST_ITEMS = []; renderSaleList(); 
        document.getElementById('bill-sku').value = ''; 
        document.getElementById('bill-pname').value = ''; 
        document.getElementById('bill-avail-qty').value = ''; 
        document.getElementById('bill-sale-qty').value = ''; 
        document.getElementById('cust-phone').value = ''; 
        document.getElementById('cust-name').value = ''; 
        document.getElementById('cust-address').value = ''; 
        document.getElementById('discount-value').value = ''; 
        document.getElementById('shipping-charges').value = ''; 
        document.getElementById('payment-amount').value = ''; 
        
        var histDiv = document.getElementById('cust-history-status');
        histDiv.classList.add('hidden');
        histDiv.style.display = 'none';
        histDiv.innerHTML = '';
        
        updateBillingSummary(); 
    }
    
    function renderSaleList() { var tbody = document.getElementById('sale-list-body'); tbody.innerHTML = SALE_LIST_ITEMS.map(function(i, x) { var iDisc = i.itemDiscount ? i.itemDiscount : ''; var iType = i.itemDiscountType || 'percent'; return `<tr data-index="${x}"><td class="py-2 pl-4 pr-3 text-sm font-semibold text-gray-700 dark:text-gray-300">${i.sku}</td><td class="px-3 py-2 text-sm">${i.name}</td><td class="px-3 py-2 text-sm">${i.quantity}</td><td class="px-3 py-2 text-sm">${i.mrp.toFixed(2)}</td><td class="px-3 py-2 text-sm"><div class="flex items-center justify-start gap-1"><input type="number" placeholder="0" class="w-16 border border-gray-300 rounded px-2 py-1 text-center item-discount-val focus:outline-none focus:border-indigo-500 no-spinners" value="${iDisc}"><select class="w-10 border border-gray-300 rounded px-1 py-1 text-center item-discount-type bg-transparent focus:outline-none focus:border-indigo-500 cursor-pointer" style="-webkit-appearance: none; -moz-appearance: none; appearance: none; text-align-last: center;"><option value="percent" ${iType === 'percent' ? 'selected' : ''}>%</option><option value="amount" ${iType === 'amount' ? 'selected' : ''}>৳</option></select></div></td><td class="px-3 py-2 text-sm item-total-display">${i.total.toFixed(2)}</td><td class="px-3 py-2 text-sm"><button class="text-red-500 remove-sale-item-btn font-bold hover:text-red-700">X</button></td></tr>`; }).join(''); tbody.querySelectorAll('.item-discount-val, .item-discount-type').forEach(function(el) { el.addEventListener('input', function(e) { var tr = e.target.closest('tr'); var idx = tr.dataset.index; var val = parseFloat(tr.querySelector('.item-discount-val').value) || 0; var type = tr.querySelector('.item-discount-type').value; var item = SALE_LIST_ITEMS[idx]; item.itemDiscount = val; item.itemDiscountType = type; var baseTotal = item.mrp * item.quantity; var discountAmt = type === 'percent' ? (baseTotal * val) / 100 : val; item.total = baseTotal - discountAmt; if(item.total < 0) item.total = 0; tr.querySelector('.item-total-display').textContent = item.total.toFixed(2); updateBillingSummary(); }); }); tbody.querySelectorAll('.remove-sale-item-btn').forEach(function(b) { b.addEventListener('click', function(e) { SALE_LIST_ITEMS.splice(e.target.closest('tr').dataset.index, 1); renderSaleList(); updateBillingSummary(); }); }); checkDiscountExclusivity(); }
    function onFailure(error) { console.error('Error:', error); showToast(error.message || 'An unknown error occurred.', 'error'); hideLoader(); }
    function showToast(message, type = 'success') { var c = document.getElementById('toast-container'); var t = document.createElement('div'); t.className = 'toast ' + type; t.textContent = message; c.appendChild(t); setTimeout(function() { t.classList.add('show'); }, 100); setTimeout(function() { t.classList.remove('show'); setTimeout(function() { t.remove(); }, 500); }, 4000); }
    function filterData(dataArray, searchTerm, columnsToSearch) { var term = searchTerm.toLowerCase(); if (!term) return dataArray; return dataArray.filter(function(row) { return columnsToSearch.some(function(colIndex) { return row[colIndex] && row[colIndex].toString().toLowerCase().includes(term); }); }); }
    
    function downloadCsvFromArray(filename, headers, dataArray, mappingFn) {
        if (!dataArray || dataArray.length === 0) return showToast('No data to download.', 'error');
        var csv = [];
        csv.push(headers.map(function(h) { return '"' + h + '"'; }).join(','));
        dataArray.forEach(function(row) {
            var rowData = mappingFn(row);
            var formattedRow = rowData.map(function(cellText) {
                if (String(cellText).startsWith('="')) return cellText;
                return '"' + String(cellText).replace(/"/g, '""') + '"';
            });
            csv.push(formattedRow.join(','));
        });
        var csvContent = '\uFEFF' + csv.join('\n');
        var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        var link = document.createElement("a");
        if (link.download !== undefined) {
            var url = URL.createObjectURL(blob); link.setAttribute("href", url); link.setAttribute("download", filename); link.style.visibility = 'hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }
    }

    function printInvoice(data) { var itemsHtml = data.items.map(function(i) { var dVal = parseFloat(i.itemDiscount) || 0; var dStr = dVal > 0 ? (i.itemDiscountType === 'percent' ? dVal + '%' : dVal + ' Tk') : '0'; return `<tr><td>${i.name}</td><td>${i.quantity}</td><td>${(typeof i.mrp === 'number' ? i.mrp.toFixed(2) : i.mrp)}</td><td>${dStr}</td><td>${(typeof i.total === 'number' ? i.total.toFixed(2) : i.total)}</td></tr>`; }).join(''); var globalDiscText = data.discount && data.discount.toString().includes('%') ? data.discount : (parseFloat(data.discount) || 0).toFixed(2) + ' Tk'; var receiptContent = `<div class="invoice"><div class="center bold">SUNDORICA</div><div class="center">Phone: 01617970053</div><div class="center">House-28,Road-16,Block-C , Avenue 5 Mirpur -11</div><hr><div>Date: ${data.saleDate}</div><div>Invoice #: ${data.invoiceId}</div><div style="margin-top:10px;"><div class="bold">To,</div><div>${data.customer.name}</div><div>Phone: ${data.customer.phone}</div><div>${data.customer.address || ''}</div></div><div class="section-title">Product Details</div><table><thead><tr><th>Product</th><th>Qty</th><th>Price</th><th>Discount</th><th>Total</th></tr></thead><tbody>${itemsHtml}</tbody></table><div class="totals"><div>Subtotal: ${data.subtotal.toFixed(2)} BDT</div><div>Discount: ${globalDiscText}</div><div>Shipping Charges: ${(parseFloat(data.shipping) || 0).toFixed(2)} BDT</div><div>Paid Amount: ${(parseFloat(data.payment) || 0).toFixed(2)} BDT</div><div><strong>Due Amount:</strong> ${(parseFloat(data.due) || 0).toFixed(2)} BDT</div></div><div class="footer">--- Thank you for choosing SUNDORICA. Stay elegant, stay confident. ---</div></div>`; var styles = `@page { size: 58mm auto; margin: 0; } body { font-family: 'Arial', sans-serif; width: 88mm; margin: 0; padding: 0; font-size: 13px; color: #000; font-weight: 600; } .invoice { padding: 3mm; box-sizing: border-box; } .center { text-align: center; } .bold { font-weight: 800; } hr { border: none; border-top: 1px dashed #000; margin: 5px 0; } table { width: 100%; border-collapse: collapse; margin-top: 5px; } th, td { text-align: left; padding: 3px 0; font-size: 12px; } .section-title { margin-top: 10px; font-weight: 800; text-decoration: underline; } .totals { margin-top: 5px; border-top: 1px dashed #000; padding-top: 5px; } .totals div { padding: 2px 0; font-weight: 600; } .footer { margin-top: 10px; text-align: center; font-size: 11px; }`; var iframe = document.createElement('iframe'); iframe.style.position = 'absolute'; iframe.style.width = '0px'; iframe.style.height = '0px'; iframe.style.border = '0'; document.body.appendChild(iframe); var doc = iframe.contentDocument || iframe.contentWindow.document; doc.open(); doc.write(`<!DOCTYPE html><html><head><title>Invoice #${data.invoiceId}</title><style>${styles}</style></head><body>${receiptContent}</body></html>`); doc.close(); setTimeout(function() { iframe.contentWindow.focus(); iframe.contentWindow.print(); document.body.removeChild(iframe); }, 500); }
    function printBarcodes(labels) { var perPage = 50; var htmlContent = ''; for (var i = 0; i < labels.length; i += perPage) { var pageLabels = labels.slice(i, i + perPage); htmlContent += '<div class="page">' + pageLabels.map(function(l) { var u = 'https://bwipjs-api.metafloor.com/?bcid=code128&text=' + encodeURIComponent(l.code) + '&scale=1&width=200&height=40&includetext=false'; return `<div class="label"><div class="store">SUNDORICA</div><div class="product">${l.productName || ""}</div><img class="barcode" src="${u}" alt="Barcode for ${l.code}"><div class="code"> ${l.code}</div><div class="price">Price: ৳${l.price} + VAT</div></div>`; }).join('') + '</div>'; } var bH = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>📦 Barcode Labels Preview</title><style>body{font-family:Arial,sans-serif;margin:10px;}.print-button{position:fixed;top:10px;right:20px;padding:10px 20px;font-size:16px;z-index:999;background:#007bff;color:white;border:none;border-radius:5px;cursor:pointer;}.page{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;width:930px;margin:0 auto;box-sizing:border-box;padding:10px;page-break-after:always;}.label{width:173px;height:110px;border:1px solid #000;padding:6px 4px;box-sizing:border-box;text-align:center;font-size:11px;display:flex;flex-direction:column;justify-content:space-between;overflow:hidden;}.store{font-weight:bold;font-size:12px;}.product{font-size:10px;line-height:1.2;word-wrap:break-word;}.code{font-size:10px;letter-spacing:1px;margin-top:2px;}.price{font-weight:bold;font-size:11px;color:#000;margin-top:2px;}img.barcode{display:block;margin:2px auto 1px;max-height:40px;width:140px;object-fit:contain;}@media print{.print-button{display:none!important;}}</style></head><body><button class="print-button" onclick="window.print()">🖨️ Print</button>${htmlContent}</body></html>`; var pW = window.open('', '_blank'); pW.document.write(bH); pW.document.close(); }
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<script>
    (function() { var qr = new QRious({ element: document.getElementById('generated-qr-code'), value: 'https://qr.bka.sh/281014021NBcnJjjAO024477F6', size: 200, background: 'white', foreground: 'black', level: 'H' }); })();
</script>
</body>
</html>
